<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Zamorins - Restaurant Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ===== CSS DESIGN SYSTEM ===== */
        :root {
            /* Colors */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --border: #334155;
            --border-focus: #3b82f6;

            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --text-dim: #64748b;

            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;

            /* Typography */
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 2rem;

            /* Touch */
            --touch-min: 44px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;

            /* Transitions */
            --transition: 200ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-secondary);
            min-height: 100vh;
            padding-bottom: 70px; /* Space for bottom nav on mobile */
        }

        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header h1 {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--text-primary);
        }

        .header .subtitle {
            display: none;
        }

        @media (min-width: 768px) {
            .header {
                padding: var(--space-lg) var(--space-xl);
            }
            .header h1 {
                font-size: var(--text-2xl);
            }
            .header .subtitle {
                display: block;
                color: var(--text-muted);
                font-size: var(--text-sm);
                margin-top: var(--space-xs);
            }
        }

        .last-updated {
            color: var(--text-dim);
            font-size: var(--text-xs);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .refresh-btn {
            padding: var(--space-sm);
            min-width: var(--touch-min);
            min-height: var(--touch-min);
            background: var(--success);
            border: none;
            border-radius: var(--radius-sm);
            color: #fff;
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            transition: all var(--transition);
            touch-action: manipulation;
        }

        .refresh-btn .refresh-text {
            display: none;
        }

        @media (min-width: 768px) {
            .refresh-btn {
                padding: var(--space-sm) var(--space-md);
            }
            .refresh-btn .refresh-text {
                display: inline;
            }
        }

        .refresh-btn:hover {
            background: #16a34a;
        }

        .refresh-btn:active {
            transform: scale(0.97);
        }

        .refresh-btn:disabled {
            background: var(--text-dim);
            cursor: not-allowed;
        }

        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-status {
            font-size: var(--text-xs);
            color: var(--text-muted);
        }

        .refresh-status.success { color: var(--success); }
        .refresh-status.error { color: var(--danger); }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-md);
        }

        @media (min-width: 768px) {
            .container {
                padding: var(--space-lg);
            }
        }

        /* ===== DESKTOP TABS (hidden on mobile) ===== */
        .tabs {
            display: none;
            gap: var(--space-sm);
            margin-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border);
            padding-bottom: var(--space-md);
        }

        @media (min-width: 768px) {
            .tabs {
                display: flex;
            }
        }

        .tab {
            padding: var(--space-sm) var(--space-lg);
            min-height: var(--touch-min);
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 500;
            transition: all var(--transition);
            touch-action: manipulation;
        }

        .tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab:active {
            transform: scale(0.97);
        }

        .tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== MOBILE BOTTOM NAVIGATION ===== */
        .mobile-nav {
            display: flex;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: var(--space-xs) 0;
            padding-bottom: calc(var(--space-xs) + env(safe-area-inset-bottom, 0));
            z-index: 100;
        }

        @media (min-width: 768px) {
            .mobile-nav {
                display: none;
            }
        }

        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: var(--space-sm) var(--space-xs);
            min-height: var(--touch-min);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: color var(--transition);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .mobile-nav-item:active {
            opacity: 0.8;
        }

        .mobile-nav-item.active {
            color: var(--accent);
        }

        .mobile-nav-icon {
            font-size: 1.25rem;
        }

        .mobile-nav-label {
            font-size: 10px;
            font-weight: 500;
        }

        /* ===== PERIOD SELECTOR ===== */
        .period-selector {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            padding-bottom: var(--space-xs);
        }

        .period-selector::-webkit-scrollbar {
            display: none;
        }

        .period-btn {
            padding: var(--space-sm) var(--space-md);
            min-height: var(--touch-min);
            white-space: nowrap;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: all var(--transition);
            touch-action: manipulation;
        }

        .period-btn:active {
            transform: scale(0.97);
        }

        .period-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        /* ===== METRICS GRID ===== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        @media (min-width: 480px) {
            .metrics-grid {
                gap: var(--space-md);
            }
        }

        @media (min-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: var(--space-lg);
                margin-bottom: var(--space-lg);
            }
        }

        .metric-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .metric-card {
                padding: var(--space-lg);
            }
        }

        .metric-card.highlight {
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, #1e3a5f 100%);
        }

        .metric-card.positive {
            border-color: var(--success);
        }

        .metric-card.negative {
            border-color: var(--danger);
        }

        .metric-card .label {
            color: var(--text-muted);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-xs);
        }

        .metric-card .value {
            font-size: var(--text-xl);
            font-weight: 700;
            color: var(--text-primary);
        }

        @media (min-width: 768px) {
            .metric-card .value {
                font-size: var(--text-2xl);
            }
        }

        .metric-card .value.positive { color: var(--success); }
        .metric-card .value.negative { color: var(--danger); }

        .metric-card .subtext {
            font-size: var(--text-xs);
            color: var(--text-dim);
            margin-top: var(--space-xs);
        }

        /* ===== CHARTS ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-md);
            margin-bottom: var(--space-md);
        }

        @media (min-width: 768px) {
            .charts-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-lg);
                margin-bottom: var(--space-lg);
            }
        }

        .chart-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--border);
        }

        @media (min-width: 768px) {
            .chart-card {
                padding: var(--space-lg);
            }
        }

        .chart-card h3 {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-md);
        }

        .chart-container {
            position: relative;
            height: 200px;
        }

        @media (min-width: 480px) {
            .chart-container {
                height: 240px;
            }
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 280px;
            }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* ===== TABLES ===== */
        .table-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: var(--space-md);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: var(--space-md);
        }

        @media (min-width: 768px) {
            .table-card {
                padding: var(--space-lg);
                margin-bottom: var(--space-lg);
            }
        }

        .table-card h3 {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-md);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: var(--space-sm);
            font-size: var(--text-xs);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border);
        }

        .data-table th.right {
            text-align: right;
        }

        .data-table td {
            padding: var(--space-sm);
            font-size: var(--text-sm);
            border-bottom: 1px solid var(--border);
        }

        .data-table td.right {
            text-align: right;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table .total-row {
            font-weight: 600;
            background: var(--bg-tertiary);
        }

        .data-table .total-row td {
            border-top: 2px solid #475569;
        }

        .data-table .section-header td {
            background: var(--bg-secondary);
            padding-top: var(--space-md);
            border-bottom: none;
        }

        .data-table .subtotal-row {
            background: var(--bg-secondary);
        }

        .data-table .subtotal-row td {
            border-top: 1px solid #475569;
        }

        .data-table .indent {
            padding-left: var(--space-lg);
        }

        .category-badge {
            display: inline-block;
            padding: var(--space-xs) var(--space-sm);
            border-radius: 4px;
            font-size: var(--text-xs);
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        /* ===== EXPANDABLE ROWS ===== */
        .expandable-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .expandable-row {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .expandable-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md);
            min-height: var(--touch-min);
            cursor: pointer;
            transition: background var(--transition);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .expandable-row-header:active {
            background: var(--bg-tertiary);
        }

        .expandable-row-header .row-title {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .expandable-row-header .row-value {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .expandable-row-header .expand-icon {
            color: var(--text-muted);
            font-size: var(--text-xs);
            transition: transform var(--transition);
        }

        .expandable-row.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .expandable-row-content {
            display: none;
            padding: 0 var(--space-md) var(--space-md);
            border-top: 1px solid var(--border);
        }

        .expandable-row.expanded .expandable-row-content {
            display: block;
        }

        .sub-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            padding-left: var(--space-md);
            border-bottom: 1px solid var(--border);
            font-size: var(--text-sm);
        }

        .sub-row:last-child {
            border-bottom: none;
        }

        .sub-row .sub-label {
            color: var(--text-muted);
        }

        .sub-row .sub-value {
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-secondary);
        }

        /* ===== P&L SPECIFIC ===== */
        .pnl-section {
            margin-bottom: var(--space-md);
        }

        .pnl-section h4 {
            font-size: var(--text-xs);
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border);
        }

        .pnl-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            font-size: var(--text-sm);
        }

        .pnl-row.indent {
            padding-left: var(--space-md);
            color: var(--text-muted);
        }

        .pnl-row.total {
            font-weight: 600;
            border-top: 1px solid #475569;
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
        }

        .pnl-row.grand-total {
            font-size: var(--text-base);
            font-weight: 700;
            border-top: 2px solid #475569;
            margin-top: var(--space-sm);
            padding-top: var(--space-sm);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-dim);
        }

        /* ===== TWO COLUMN LAYOUT ===== */
        .two-col {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-md);
        }

        @media (min-width: 768px) {
            .two-col {
                grid-template-columns: 1fr 1fr;
                gap: var(--space-lg);
            }
        }

        /* ===== EXPANDABLE METRIC CARDS ===== */
        .metric-card.expandable {
            cursor: pointer;
            transition: all var(--transition);
            -webkit-tap-highlight-color: transparent;
        }

        .metric-card.expandable:active {
            transform: scale(0.98);
        }

        @media (min-width: 768px) {
            .metric-card.expandable:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }
        }

        .metric-card .expand-icon {
            float: right;
            color: var(--text-dim);
            font-size: var(--text-xs);
            transition: transform var(--transition);
        }

        .metric-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .metric-card .detail-panel {
            display: none;
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border);
        }

        .metric-card.expanded .detail-panel {
            display: block;
        }

        .detail-panel .view-toggle {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
            overflow-x: auto;
        }

        .detail-panel .view-btn {
            padding: var(--space-sm) var(--space-md);
            min-height: 36px;
            font-size: var(--text-xs);
            border: 1px solid #475569;
            background: transparent;
            color: var(--text-muted);
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition);
            white-space: nowrap;
        }

        .detail-panel .view-btn:active {
            transform: scale(0.97);
        }

        .detail-panel .view-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            font-size: var(--text-sm);
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row .label {
            color: var(--text-muted);
            font-size: var(--text-sm);
            text-transform: none;
            letter-spacing: normal;
        }

        .detail-row .amount {
            font-family: 'SF Mono', Monaco, monospace;
            color: var(--text-secondary);
        }

        .detail-row.sub-item {
            padding-left: var(--space-md);
            font-size: var(--text-xs);
        }

        .detail-row.sub-item .label {
            color: var(--text-dim);
        }

        .detail-section-title {
            font-size: var(--text-xs);
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--space-sm);
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-xs);
            border-bottom: 1px dashed #475569;
        }

        .badge-fixed {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            background: #1e3a5f;
            color: #60a5fa;
            border-radius: 3px;
            margin-left: var(--space-sm);
        }

        .badge-variable {
            display: inline-block;
            padding: 2px 6px;
            font-size: 10px;
            background: #3f3f1e;
            color: #fbbf24;
            border-radius: 3px;
            margin-left: var(--space-sm);
        }

        /* ===== TYPE FILTER (for expenses) ===== */
        .type-filter {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .type-btn {
            padding: var(--space-sm) var(--space-md);
            min-height: var(--touch-min);
            white-space: nowrap;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: all var(--transition);
            touch-action: manipulation;
        }

        .type-btn:active {
            transform: scale(0.97);
        }

        .type-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        /* ===== SUMMARY CARDS ROW ===== */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            text-align: center;
        }

        .summary-card .summary-value {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-card .summary-label {
            font-size: var(--text-xs);
            color: var(--text-muted);
            margin-top: var(--space-xs);
        }

        @media (min-width: 768px) {
            .summary-card .summary-value {
                font-size: var(--text-xl);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div>
            <h1>The Zamorins</h1>
            <div class="subtitle">Restaurant Analytics Dashboard</div>
        </div>
        <div class="header-actions">
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                <span class="refresh-icon">&#8635;</span>
                <span class="refresh-text">Refresh Data</span>
            </button>
            <div>
                <div class="last-updated" id="lastUpdated">Loading...</div>
                <div class="refresh-status" id="refreshStatus"></div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="sales">Sales Analysis</button>
            <button class="tab" data-tab="menu-costs">Menu Costs</button>
            <button class="tab" data-tab="inventory">Inventory</button>
            <button class="tab" data-tab="financials">P&L Statement</button>
            <button class="tab" data-tab="expenses">Expenses</button>
            <button class="tab" data-tab="balance-sheet">Balance Sheet</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Period Selector -->
            <div class="period-selector">
                <button class="period-btn active" data-period="all" onclick="setPeriod('all')">All Time</button>
                <button class="period-btn" data-period="month" onclick="setPeriod('month')">This Month</button>
                <button class="period-btn" data-period="week" onclick="setPeriod('week')">This Week</button>
            </div>
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card highlight expandable" id="revenueCard" onclick="toggleExpand('revenueCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Total Revenue</div>
                    <div class="value" id="totalRevenue">--</div>
                    <div class="subtext" id="avgDaily">-- avg/day</div>
                    <div class="detail-panel" id="revenueDetails"></div>
                </div>
                <div class="metric-card expandable" id="cogsCard" onclick="toggleExpand('cogsCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Cost of Goods Sold</div>
                    <div class="value" id="totalCogs">--</div>
                    <div class="subtext" id="cogsSubtext">Food costs</div>
                    <div class="detail-panel" id="cogsDetails"></div>
                </div>
                <div class="metric-card expandable" id="opexCard" onclick="toggleExpand('opexCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Operating Expenses</div>
                    <div class="value" id="totalOpex">--</div>
                    <div class="subtext" id="opexSubtext">Recurring costs</div>
                    <div class="detail-panel" id="opexDetails"></div>
                </div>
                <div class="metric-card" id="profitCard">
                    <div class="label" id="profitLabel">Net Profit</div>
                    <div class="value" id="operatingProfit">--</div>
                    <div class="subtext" id="marginPct">-- margin</div>
                </div>
                <div class="metric-card">
                    <div class="label">Items Sold</div>
                    <div class="value" id="itemsSold">--</div>
                    <div class="subtext" id="avgItems">-- avg/day</div>
                </div>
                <div class="metric-card expandable" id="capexCard" onclick="toggleExpand('capexCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Capital Investment</div>
                    <div class="value" id="totalCapex">--</div>
                    <div class="subtext">One-time setup</div>
                    <div class="detail-panel" id="capexDetails"></div>
                </div>
                <div class="metric-card">
                    <div class="label">Days Recorded</div>
                    <div class="value" id="daysRecorded">--</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card full-width">
                    <h3>Daily Revenue Trend</h3>
                    <div class="chart-container">
                        <canvas id="revenueTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Sales by Category</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Operating Expenses Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="opexChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-card">
                <h3>Top Selling Items</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:40px">#</th>
                            <th>Item</th>
                            <th>Category</th>
                            <th class="right">Qty</th>
                            <th class="right">Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="topItemsTable">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Analysis Tab -->
        <div id="sales" class="tab-content">
            <!-- Sales Period Selector -->
            <div class="period-selector">
                <button class="period-btn" data-sales-period="daily" onclick="setSalesPeriod('daily')">Daily</button>
                <button class="period-btn" data-sales-period="weekly" onclick="setSalesPeriod('weekly')">Weekly</button>
                <button class="period-btn" data-sales-period="monthly" onclick="setSalesPeriod('monthly')">Monthly</button>
                <button class="period-btn active" data-sales-period="all" onclick="setSalesPeriod('all')">All Time</button>
            </div>

            <!-- Sales Summary -->
            <div class="summary-row">
                <div class="summary-card">
                    <div class="summary-value" id="salesRevenue">--</div>
                    <div class="summary-label">Revenue</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="salesItems">--</div>
                    <div class="summary-label">Items</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="salesBills">--</div>
                    <div class="summary-label">Bills</div>
                </div>
            </div>

            <!-- Sales Chart -->
            <div class="chart-card" style="margin-bottom: var(--space-md);">
                <h3>Revenue Trend</h3>
                <div class="chart-container">
                    <canvas id="salesItemsChart"></canvas>
                </div>
            </div>

            <!-- Category Drill-Down -->
            <div class="table-card">
                <h3>Sales by Category</h3>
                <div class="expandable-list" id="salesCategoryList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Menu Costs Tab -->
        <div id="menu-costs" class="tab-content">
            <!-- Summary Cards -->
            <div class="summary-cards-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:var(--space-md);margin-bottom:var(--space-lg);">
                <div class="summary-card">
                    <div class="summary-value" id="menuAvgMargin">--</div>
                    <div class="summary-label">Avg Margin</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="menuFoodCost">--</div>
                    <div class="summary-label">Food Cost %</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="menuTotalItems">--</div>
                    <div class="summary-label">Menu Items</div>
                </div>
            </div>

            <!-- Category Filter -->
            <div class="type-filter" style="margin-bottom:var(--space-md);">
                <button class="type-btn active" data-menu-cat="all" onclick="filterMenuCategory('all')">All</button>
                <button class="type-btn" data-menu-cat="DOSA" onclick="filterMenuCategory('DOSA')">Dosa</button>
                <button class="type-btn" data-menu-cat="BREAKFAST" onclick="filterMenuCategory('BREAKFAST')">Breakfast</button>
                <button class="type-btn" data-menu-cat="LUNCH" onclick="filterMenuCategory('LUNCH')">Lunch</button>
                <button class="type-btn" data-menu-cat="DINNER" onclick="filterMenuCategory('DINNER')">Dinner</button>
                <button class="type-btn" data-menu-cat="SNACKS" onclick="filterMenuCategory('SNACKS')">Snacks</button>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Margin by Category</h3>
                    <div class="chart-container">
                        <canvas id="marginByCategoryChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Top 10 High Margin Items</h3>
                    <div class="chart-container">
                        <canvas id="bestMarginsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Menu Items Table -->
            <div class="table-card">
                <h3>Menu Items Cost Analysis</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Category</th>
                            <th class="right">Price</th>
                            <th class="right">Cost</th>
                            <th class="right">Margin</th>
                            <th class="right">%</th>
                        </tr>
                    </thead>
                    <tbody id="menuCostsTable">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Worst Margins Alert -->
            <div class="table-card" style="border-left:3px solid var(--warning);">
                <h3 style="color:var(--warning);">⚠️ Low Margin Items (Review Pricing)</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Category</th>
                            <th class="right">Price</th>
                            <th class="right">Cost</th>
                            <th class="right">Margin %</th>
                        </tr>
                    </thead>
                    <tbody id="worstMarginsTable">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <!-- Summary Cards -->
            <div class="summary-cards-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:var(--space-md);margin-bottom:var(--space-lg);">
                <div class="summary-card">
                    <div class="summary-value" id="invTotalOrders">--</div>
                    <div class="summary-label">Orders Analyzed</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="invMatchRate">--</div>
                    <div class="summary-label">Match Rate</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="invIngredients">--</div>
                    <div class="summary-label">Ingredients Used</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="invTotalCost">--</div>
                    <div class="summary-label">Est. Ingredient Cost</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card full-width">
                    <h3>Top 10 Ingredients by Usage (kg)</h3>
                    <div class="chart-container">
                        <canvas id="ingredientUsageChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Ingredient Usage Table -->
            <div class="table-card">
                <h3>Ingredient Usage Analysis</h3>
                <p style="color:var(--text-muted);font-size:0.75rem;margin-bottom:1rem;" id="invSourceNote">Based on sales data</p>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th class="right">Total (kg)</th>
                            <th class="right">Orders</th>
                            <th class="right">Cost/kg</th>
                            <th class="right">Total Cost</th>
                        </tr>
                    </thead>
                    <tbody id="ingredientUsageTable">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Unmatched Items (for debugging) -->
            <div class="table-card" style="border-left:3px solid var(--text-muted);">
                <h3 style="color:var(--text-muted);">Unmatched Items (not in recipe database)</h3>
                <div id="unmatchedItemsList" style="color:var(--text-dim);font-size:0.8rem;">
                    Loading...
                </div>
            </div>
        </div>

        <!-- P&L Statement Tab -->
        <div id="financials" class="tab-content">
            <div class="two-col">
                <div class="table-card">
                    <h3>Profit & Loss Statement</h3>
                    <div class="subtext" id="pnlPeriod" style="color:#64748b;font-size:0.75rem;margin-bottom:1rem;">Period: --</div>
                    <div id="pnlStatement">
                        <div class="pnl-section">
                            <h4>Revenue</h4>
                            <div id="pnlRevenueLines"></div>
                            <div class="pnl-row total">
                                <span>Total Revenue</span>
                                <span id="pnlTotalRevenue">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <h4>Cost of Goods Sold (COGS)</h4>
                            <div id="pnlCogsLines"></div>
                            <div class="pnl-row total">
                                <span>Total COGS</span>
                                <span id="pnlTotalCogs">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <div class="pnl-row total" style="background:#1e3a5f;padding:0.75rem;border-radius:6px;">
                                <span>Gross Profit</span>
                                <span id="pnlGrossProfit">--</span>
                            </div>
                            <div class="pnl-row indent" style="font-size:0.75rem;">
                                <span>Gross Margin</span>
                                <span id="pnlGrossMargin">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <h4>Operating Expenses</h4>
                            <div id="pnlOpexLines"></div>
                            <div class="pnl-row total">
                                <span>Total Operating Expenses</span>
                                <span id="pnlTotalOpex">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <div class="pnl-row total" style="background:#1e3a5f;padding:0.75rem;border-radius:6px;">
                                <span>Operating Profit</span>
                                <span id="pnlOperatingProfit">--</span>
                            </div>
                            <div class="pnl-row indent" style="font-size:0.75rem;">
                                <span>Operating Margin</span>
                                <span id="pnlOpMargin">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <h4>Other Expenses</h4>
                            <div class="pnl-row indent">
                                <span>Uncategorized / Other</span>
                                <span id="pnlOtherExpenses">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <div class="pnl-row grand-total" id="pnlProfitRow">
                                <span>Net Profit / (Loss)</span>
                                <span id="pnlNetProfit">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <h3>Monthly P&L Trend</h3>
                    <div class="chart-container">
                        <canvas id="monthlyPnlChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="table-card">
                    <h3>Monthly Breakdown</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="right">Revenue</th>
                                <th class="right">COGS</th>
                                <th class="right">Gross Profit</th>
                                <th class="right">OpEx</th>
                                <th class="right">Op. Profit</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyPnlTable"></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <h3>Top Vendors by Spend</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Type</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="vendorTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <!-- Type Filter -->
            <div class="type-filter">
                <button class="type-btn active" data-exp-type="all" onclick="setExpenseType('all')">All</button>
                <button class="type-btn" data-exp-type="cogs" onclick="setExpenseType('cogs')">COGS</button>
                <button class="type-btn" data-exp-type="opex" onclick="setExpenseType('opex')">OpEx</button>
                <button class="type-btn" data-exp-type="capex" onclick="setExpenseType('capex')">CapEx</button>
            </div>

            <!-- Summary Cards -->
            <div class="summary-row">
                <div class="summary-card" id="cogsSummary">
                    <div class="summary-value" id="expCogs">--</div>
                    <div class="summary-label">COGS</div>
                </div>
                <div class="summary-card" id="opexSummary">
                    <div class="summary-value" id="expOpex">--</div>
                    <div class="summary-label">OpEx</div>
                </div>
                <div class="summary-card" id="capexSummary">
                    <div class="summary-value" id="expCapex">--</div>
                    <div class="summary-label">CapEx</div>
                </div>
            </div>

            <!-- Expenses Drill-Down List -->
            <div class="table-card">
                <h3 id="expensesListTitle">All Expenses by Category</h3>
                <div class="expandable-list" id="expensesCategoryList">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Partner Contributions -->
            <div class="table-card" id="partnerSection">
                <h3>Partner Contributions (CapEx)</h3>
                <div class="expandable-list" id="partnerList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Balance Sheet Tab -->
        <div id="balance-sheet" class="tab-content">
            <div class="metrics-grid">
                <div class="metric-card highlight">
                    <div class="label">Total Assets</div>
                    <div class="value" id="bsAssets">--</div>
                </div>
                <div class="metric-card">
                    <div class="label">Total Liabilities</div>
                    <div class="value" id="bsLiabilities">--</div>
                </div>
                <div class="metric-card">
                    <div class="label">Equity</div>
                    <div class="value" id="bsEquity">--</div>
                </div>
            </div>

            <div class="two-col">
                <div class="table-card">
                    <h3>Assets</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="assetsTable"></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <h3>Liabilities & Equity</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="liabilitiesTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <p class="subtext" style="padding: 1rem; color: #64748b;">
                    As of <span id="bsAsOf">--</span> | 
                    Security Deposits are recoverable assets (not expenses)
                </p>
            </div>
        </div>
    </div>

    <script>
        // Chart.js global defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

        const colors = {
            primary: '#3b82f6',
            secondary: '#8b5cf6',
            success: '#22c55e',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#06b6d4',
            chart: ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899', '#84cc16']
        };

        let currentPeriod = 'all';
        let currentSalesPeriod = 'all';
        let currentExpenseType = 'all';
        let globalData = null;
        let globalFinData = null;

        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            updateMetricsForPeriod();
        }

        function updateMetricsForPeriod() {
            if (!globalFinData) return;

            const now = new Date();
            const thisMonth = now.toISOString().slice(0, 7);
            const weekly = globalFinData.weekly || [];
            const monthly = globalFinData.monthly || [];

            let revenue = 0, cogs = 0, opex = 0, days = 0;

            if (currentPeriod === 'all') {
                revenue = globalFinData.pnl.revenue.total;
                cogs = globalFinData.pnl.cogs.total;
                opex = globalFinData.pnl.opex.total;
                days = globalFinData.period ? (globalFinData.period.days || monthly.length * 30) : 61;
            } else if (currentPeriod === 'month') {
                // Get current month data
                const monthData = monthly.find(m => m.month === thisMonth) || monthly[monthly.length - 1];
                if (monthData) {
                    revenue = monthData.revenue;
                    cogs = monthData.cogs;
                    opex = monthData.opex;
                    days = 30;
                }
            } else if (currentPeriod === 'week') {
                // Get latest week data
                const weekData = weekly[weekly.length - 1];
                if (weekData) {
                    revenue = weekData.revenue;
                    cogs = weekData.cogs;
                    opex = weekData.opex;
                    days = 7;
                }
            }

            document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
            document.getElementById('avgDaily').textContent = formatCurrency(revenue / Math.max(days, 1)) + ' avg/day';
            document.getElementById('totalCogs').textContent = formatCurrency(cogs);
            document.getElementById('totalOpex').textContent = formatCurrency(opex);
            document.getElementById('daysRecorded').textContent = days;

            const profit = revenue - cogs - opex;
            document.getElementById('operatingProfit').textContent = formatCurrency(profit);
            document.getElementById('operatingProfit').className = 'value ' + (profit >= 0 ? 'positive' : 'negative');
        }

        // ============================================
        // SALES PERIOD SELECTOR
        // ============================================
        function setSalesPeriod(period) {
            currentSalesPeriod = period;
            document.querySelectorAll('[data-sales-period]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.salesPeriod === period);
            });
            updateSalesView();
        }

        function updateSalesView() {
            if (!globalData || !globalFinData) return;

            const daily = globalData.daily_sales || [];
            const weekly = globalFinData.weekly || [];
            const monthly = globalFinData.monthly || [];

            let revenue = 0, items = 0, bills = 0, chartData = [];

            if (currentSalesPeriod === 'daily') {
                // Last 7 days
                const last7 = daily.slice(-7);
                revenue = last7.reduce((s, d) => s + d.revenue, 0);
                items = last7.reduce((s, d) => s + d.items_sold, 0);
                bills = last7.reduce((s, d) => s + d.bills, 0);
                chartData = last7;
            } else if (currentSalesPeriod === 'weekly') {
                // Last 4 weeks
                const last4 = weekly.slice(-4);
                revenue = last4.reduce((s, w) => s + w.revenue, 0);
                chartData = weekly;
            } else if (currentSalesPeriod === 'monthly') {
                revenue = monthly.reduce((s, m) => s + m.revenue, 0);
                chartData = monthly;
            } else {
                // All time
                revenue = globalData.metrics.total_revenue;
                items = globalData.metrics.total_items_sold;
                bills = daily.reduce((s, d) => s + d.bills, 0);
                chartData = daily;
            }

            document.getElementById('salesRevenue').textContent = formatCurrency(revenue);
            document.getElementById('salesItems').textContent = items > 0 ? formatNumber(items) : '--';
            document.getElementById('salesBills').textContent = bills > 0 ? formatNumber(bills) : '--';

            // Update chart
            renderSalesChart(chartData, currentSalesPeriod);
        }

        function renderSalesChart(data, period) {
            const ctx = document.getElementById('salesItemsChart').getContext('2d');
            if (chartInstances.salesItems) chartInstances.salesItems.destroy();

            let labels, revenues;
            if (period === 'monthly') {
                labels = data.map(d => d.month);
                revenues = data.map(d => d.revenue);
            } else if (period === 'weekly') {
                labels = data.map(d => {
                    const start = new Date(d.week_start);
                    return start.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                });
                revenues = data.map(d => d.revenue);
            } else {
                const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
                labels = sorted.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                });
                revenues = sorted.map(d => d.revenue);
            }

            chartInstances.salesItems = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenues,
                        backgroundColor: colors.primary,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => formatCurrency(v) }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }

        // ============================================
        // SALES CATEGORY DRILL-DOWN
        // ============================================
        function renderSalesCategoryDrilldown() {
            if (!globalData) return;

            const categories = globalData.category_sales || {};
            const topItems = globalData.top_items || [];

            const container = document.getElementById('salesCategoryList');
            if (!container) return;

            const sorted = Object.entries(categories).sort((a, b) => b[1].revenue - a[1].revenue);

            container.innerHTML = sorted.map(([category, data], idx) => {
                const categoryItems = topItems.filter(item => item.category === category);
                const itemsHtml = categoryItems.length > 0
                    ? categoryItems.map(item => `
                        <div class="sub-row">
                            <span class="sub-label">${item.item}</span>
                            <span class="sub-value">${formatNumber(item.qty)} qty · ${formatCurrency(item.revenue)}</span>
                        </div>
                    `).join('')
                    : '<div class="sub-row"><span class="sub-label">No item data</span></div>';

                return `
                    <div class="expandable-row" id="sales-cat-${idx}">
                        <div class="expandable-row-header" onclick="toggleExpandRow('sales-cat-${idx}')">
                            <span class="row-title">${category}</span>
                            <span class="row-value">
                                ${formatNumber(data.qty)} · ${formatCurrency(data.revenue)}
                                <span class="expand-icon">▼</span>
                            </span>
                        </div>
                        <div class="expandable-row-content">
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // EXPENSE TYPE FILTER
        // ============================================
        function setExpenseType(type) {
            currentExpenseType = type;
            document.querySelectorAll('[data-exp-type]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.expType === type);
            });
            updateExpenseView();
        }

        function updateExpenseView() {
            if (!globalFinData) return;

            const titles = {
                all: 'All Expenses by Category',
                cogs: 'Cost of Goods Sold (COGS)',
                opex: 'Operating Expenses (OpEx)',
                capex: 'Capital Expenditure (CapEx)'
            };
            document.getElementById('expensesListTitle').textContent = titles[currentExpenseType];

            // Show/hide partner section based on type
            const partnerSection = document.getElementById('partnerSection');
            partnerSection.style.display = (currentExpenseType === 'all' || currentExpenseType === 'capex') ? 'block' : 'none';

            renderExpensesDrilldown();
        }

        function renderExpensesDrilldown() {
            if (!globalFinData) return;

            const container = document.getElementById('expensesCategoryList');
            if (!container) return;

            let categories = {};
            let vendorData = globalFinData.vendors || [];

            if (currentExpenseType === 'all') {
                // Combine all categories
                const cogs = globalFinData.pnl?.cogs?.by_category || {};
                const opex = globalFinData.pnl?.opex?.by_category || {};
                const capex = globalFinData.capex?.by_category || {};

                Object.entries(cogs).forEach(([k, v]) => {
                    categories[k] = { amount: v, type: 'COGS' };
                });
                Object.entries(opex).forEach(([k, v]) => {
                    categories[k] = { amount: v, type: 'OpEx' };
                });
                Object.entries(capex).forEach(([k, v]) => {
                    categories[k] = { amount: v, type: 'CapEx' };
                });
            } else if (currentExpenseType === 'cogs') {
                const cogs = globalFinData.pnl?.cogs?.by_category || {};
                Object.entries(cogs).forEach(([k, v]) => {
                    categories[k] = { amount: v, type: 'COGS' };
                });
                vendorData = vendorData.filter(v => v.expense_type === 'cogs');
            } else if (currentExpenseType === 'opex') {
                const opex = globalFinData.pnl?.opex?.by_category || {};
                Object.entries(opex).forEach(([k, v]) => {
                    categories[k] = { amount: v, type: 'OpEx' };
                });
                vendorData = vendorData.filter(v => v.expense_type === 'opex');
            } else if (currentExpenseType === 'capex') {
                const capex = globalFinData.capex?.by_category || {};
                const details = globalFinData.capex?.details || {};
                Object.entries(capex).forEach(([k, v]) => {
                    categories[k] = { amount: v, type: 'CapEx', partners: details[k] || {} };
                });
            }

            const sorted = Object.entries(categories).sort((a, b) => b[1].amount - a[1].amount);

            container.innerHTML = sorted.map(([category, data], idx) => {
                // Find vendors for this category
                const catVendors = vendorData.filter(v => {
                    const catLower = category.toLowerCase().replace(' (partner-paid)', '');
                    const vendorCat = (v.category || '').toLowerCase();
                    return vendorCat.includes(catLower) || catLower.includes(vendorCat);
                });

                let detailHtml = '';

                if (currentExpenseType === 'capex' && data.partners) {
                    // For CapEx, show partner breakdown
                    detailHtml = Object.entries(data.partners)
                        .sort((a, b) => b[1] - a[1])
                        .map(([partner, amount]) => `
                            <div class="sub-row">
                                <span class="sub-label">${partner}</span>
                                <span class="sub-value">${formatCurrency(amount)}</span>
                            </div>
                        `).join('');
                } else if (catVendors.length > 0) {
                    detailHtml = catVendors
                        .sort((a, b) => b.total - a.total)
                        .slice(0, 5)
                        .map(v => `
                            <div class="sub-row">
                                <span class="sub-label">${v.vendor}</span>
                                <span class="sub-value">${formatCurrency(v.total)}</span>
                            </div>
                        `).join('');
                } else {
                    detailHtml = '<div class="sub-row"><span class="sub-label">No vendor breakdown</span></div>';
                }

                const typeBadge = currentExpenseType === 'all'
                    ? `<span class="category-badge">${data.type}</span>`
                    : '';

                return `
                    <div class="expandable-row" id="exp-cat-${idx}">
                        <div class="expandable-row-header" onclick="toggleExpandRow('exp-cat-${idx}')">
                            <span class="row-title">${typeBadge} ${category.replace(' (partner-paid)', '')}</span>
                            <span class="row-value">
                                ${formatCurrency(data.amount)}
                                <span class="expand-icon">▼</span>
                            </span>
                        </div>
                        <div class="expandable-row-content">
                            ${detailHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPartnerDrilldown() {
            if (!globalFinData || !globalFinData.capex) return;

            const container = document.getElementById('partnerList');
            if (!container) return;

            const byPartner = globalFinData.capex.by_partner || {};
            const details = globalFinData.capex.details || {};

            const sorted = Object.entries(byPartner).sort((a, b) => b[1] - a[1]);

            container.innerHTML = sorted.map(([partner, total], idx) => {
                // Find categories this partner contributed to
                const partnerCats = [];
                Object.entries(details).forEach(([cat, partners]) => {
                    if (partners[partner]) {
                        partnerCats.push({ category: cat, amount: partners[partner] });
                    }
                });

                const catHtml = partnerCats
                    .sort((a, b) => b.amount - a.amount)
                    .map(c => `
                        <div class="sub-row">
                            <span class="sub-label">${c.category}</span>
                            <span class="sub-value">${formatCurrency(c.amount)}</span>
                        </div>
                    `).join('');

                return `
                    <div class="expandable-row" id="partner-${idx}">
                        <div class="expandable-row-header" onclick="toggleExpandRow('partner-${idx}')">
                            <span class="row-title">${partner}</span>
                            <span class="row-value">
                                ${formatCurrency(total)}
                                <span class="expand-icon">▼</span>
                            </span>
                        </div>
                        <div class="expandable-row-content">
                            ${catHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============================================
        // EXPANDABLE ROW TOGGLE
        // ============================================
        function toggleExpandRow(id) {
            const row = document.getElementById(id);
            if (row) {
                row.classList.toggle('expanded');
            }
        }

        function formatCurrency(value) {
            if (Math.abs(value) >= 100000) {
                return (value / 100000).toFixed(2) + 'L';
            }
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('en-IN').format(Math.round(value));
        }

        // Expandable panel toggle
        function toggleExpand(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('expanded');
        }

        // Render Revenue details (by Channel)
        function renderRevenueDetails(finData) {
            if (!finData || !finData.pnl || !finData.pnl.revenue) return;

            const byChannel = finData.pnl.revenue.by_channel || {};
            const bySource = finData.pnl.revenue.by_source || finData.pnl.revenue.breakdown || {};

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showRevenueView('channel')">By Channel</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showRevenueView('source')">By Source</button>
                </div>
                <div id="revenueChannelView">
                    ${Object.entries(byChannel)
                        .filter(([_, amt]) => amt > 0)
                        .sort((a, b) => b[1] - a[1])
                        .map(([channel, amount]) => `
                            <div class="detail-row">
                                <span class="label">${channel}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
                <div id="revenueSourceView" style="display:none">
                    ${Object.entries(bySource)
                        .sort((a, b) => b[1] - a[1])
                        .map(([source, amount]) => `
                            <div class="detail-row">
                                <span class="label">${source}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('revenueDetails').innerHTML = html;
        }

        function showRevenueView(view) {
            document.getElementById('revenueChannelView').style.display = view === 'channel' ? 'block' : 'none';
            document.getElementById('revenueSourceView').style.display = view === 'source' ? 'block' : 'none';
            document.querySelectorAll('#revenueDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'channel' && i === 0) || (view === 'source' && i === 1));
            });
        }

        // Render COGS details (by Vendor + by Category)
        function renderCogsDetails(finData) {
            if (!finData || !finData.pnl || !finData.pnl.cogs) return;

            const byVendor = finData.pnl.cogs.by_vendor || finData.pnl.cogs.breakdown || {};
            const byCategory = finData.pnl.cogs.by_category || {};

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showCogsView('category')">By Category</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showCogsView('vendor')">By Vendor</button>
                </div>
                <div id="cogsCategoryView">
                    ${Object.entries(byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => `
                            <div class="detail-row">
                                <span class="label">${cat}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
                <div id="cogsVendorView" style="display:none">
                    ${Object.entries(byVendor)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                        .map(([vendor, amount]) => `
                            <div class="detail-row">
                                <span class="label">${vendor.replace(' (partner-paid)', '').replace(' (invoiced)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                    ${Object.keys(byVendor).length > 10 ? '<div class="detail-row"><span class="label" style="color:#64748b">...and more</span></div>' : ''}
                </div>
            `;
            document.getElementById('cogsDetails').innerHTML = html;
        }

        function showCogsView(view) {
            document.getElementById('cogsCategoryView').style.display = view === 'category' ? 'block' : 'none';
            document.getElementById('cogsVendorView').style.display = view === 'vendor' ? 'block' : 'none';
            document.querySelectorAll('#cogsDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'category' && i === 0) || (view === 'vendor' && i === 1));
            });
        }

        // Render OpEx details (by Category + Fixed/Variable)
        function renderOpexDetails(finData) {
            if (!finData || !finData.pnl || !finData.pnl.opex) return;

            const byCategory = finData.pnl.opex.by_category || finData.pnl.opex.breakdown || {};
            const fixed = finData.pnl.opex.fixed || {};
            const variable = finData.pnl.opex.variable || {};
            const fixedTotal = finData.pnl.opex.fixed_total || 0;
            const variableTotal = finData.pnl.opex.variable_total || 0;

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showOpexView('category')">By Category</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showOpexView('fixedvar')">Fixed/Variable</button>
                </div>
                <div id="opexCategoryView">
                    ${Object.entries(byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 8)
                        .map(([cat, amount]) => `
                            <div class="detail-row">
                                <span class="label">${cat.replace(' (partner-paid)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                    ${Object.keys(byCategory).length > 8 ? '<div class="detail-row"><span class="label" style="color:#64748b">...and more</span></div>' : ''}
                </div>
                <div id="opexFixedVarView" style="display:none">
                    <div class="detail-section-title">Fixed Costs <span class="badge-fixed">${formatCurrency(fixedTotal)}</span></div>
                    ${Object.entries(fixed)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => `
                            <div class="detail-row sub-item">
                                <span class="label">${cat.replace(' (partner-paid)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                    <div class="detail-section-title">Variable Costs <span class="badge-variable">${formatCurrency(variableTotal)}</span></div>
                    ${Object.entries(variable)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => `
                            <div class="detail-row sub-item">
                                <span class="label">${cat.replace(' (partner-paid)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('opexDetails').innerHTML = html;
        }

        function showOpexView(view) {
            document.getElementById('opexCategoryView').style.display = view === 'category' ? 'block' : 'none';
            document.getElementById('opexFixedVarView').style.display = view === 'fixedvar' ? 'block' : 'none';
            document.querySelectorAll('#opexDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'category' && i === 0) || (view === 'fixedvar' && i === 1));
            });
        }

        // Render CapEx details (by Category + by Partner)
        function renderCapexDetails(finData) {
            if (!finData || !finData.capex) return;

            const byCategory = finData.capex.by_category || finData.capex.breakdown || {};
            const byPartner = finData.capex.by_partner || {};
            const details = finData.capex.details || {};

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showCapexView('category')">By Category</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showCapexView('partner')">By Partner</button>
                </div>
                <div id="capexCategoryView">
                    ${Object.entries(byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => {
                            const partnerBreakdown = details[cat] || {};
                            const partnerStr = Object.entries(partnerBreakdown)
                                .map(([p, a]) => `${p}: ${formatCurrency(a)}`)
                                .join(', ');
                            return `
                                <div class="detail-row">
                                    <span class="label">${cat}</span>
                                    <span class="amount">${formatCurrency(amount)}</span>
                                </div>
                                ${partnerStr ? `<div class="detail-row sub-item"><span class="label">${partnerStr}</span></div>` : ''}
                            `;
                        }).join('')}
                </div>
                <div id="capexPartnerView" style="display:none">
                    ${Object.entries(byPartner)
                        .sort((a, b) => b[1] - a[1])
                        .map(([partner, amount]) => `
                            <div class="detail-row">
                                <span class="label">${partner}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('capexDetails').innerHTML = html;
        }

        function showCapexView(view) {
            document.getElementById('capexCategoryView').style.display = view === 'category' ? 'block' : 'none';
            document.getElementById('capexPartnerView').style.display = view === 'partner' ? 'block' : 'none';
            document.querySelectorAll('#capexDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'category' && i === 0) || (view === 'partner' && i === 1));
            });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        let chartInstances = {};

        async function loadDashboard() {
            try {
                // Cache-busting timestamp to ensure fresh data
                const cacheBuster = '?v=' + Date.now();

                // Load operational data
                let response;
                const paths = ['../data/dashboard_data.json', './data/dashboard_data.json', 'data/dashboard_data.json'];
                for (const path of paths) {
                    try {
                        response = await fetch(path + cacheBuster, { cache: 'no-store' });
                        if (response.ok) break;
                    } catch { continue; }
                }
                if (!response || !response.ok) throw new Error('Data not found');
                const data = await response.json();

                // Load financial data
                let finResponse;
                const finPaths = ['../data/financial_data.json', './data/financial_data.json', 'data/financial_data.json'];
                for (const path of finPaths) {
                    try {
                        finResponse = await fetch(path + cacheBuster, { cache: 'no-store' });
                        if (finResponse.ok) break;
                    } catch { continue; }
                }
                let finData = null;
                if (finResponse && finResponse.ok) {
                    finData = await finResponse.json();
                }

                // Load menu costs data
                let menuCostsData = null;
                const menuPaths = ['../data/menu_costs.json', './data/menu_costs.json', 'data/menu_costs.json'];
                for (const path of menuPaths) {
                    try {
                        const menuResponse = await fetch(path + cacheBuster, { cache: 'no-store' });
                        if (menuResponse.ok) {
                            menuCostsData = await menuResponse.json();
                            break;
                        }
                    } catch { continue; }
                }

                // Load inventory usage data
                let inventoryData = null;
                const invPaths = ['../data/inventory_usage.json', './data/inventory_usage.json', 'data/inventory_usage.json'];
                for (const path of invPaths) {
                    try {
                        const invResponse = await fetch(path + cacheBuster, { cache: 'no-store' });
                        if (invResponse.ok) {
                            inventoryData = await invResponse.json();
                            break;
                        }
                    } catch { continue; }
                }

                renderDashboard(data, finData);
                if (menuCostsData) {
                    renderMenuCosts(menuCostsData);
                }
                if (inventoryData) {
                    renderInventory(inventoryData);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('topItemsTable').innerHTML =
                    '<tr><td colspan="5" style="color:#ef4444">Error loading data</td></tr>';
            }
        }

        function renderDashboard(data, finData) {
            // Normalize data field names for compatibility
            data.category_sales = data.category_sales || data.category_breakdown || {};
            // Convert category format if needed (total -> revenue)
            if (data.category_sales && !Object.values(data.category_sales)[0]?.revenue) {
                for (const [key, val] of Object.entries(data.category_sales)) {
                    if (val.total !== undefined) val.revenue = val.total;
                }
            }
            data.metrics = data.metrics || {};
            data.metrics.total_revenue = data.metrics.total_revenue || data.metrics.total_sales || 0;
            data.metrics.avg_daily_revenue = data.metrics.avg_daily_revenue || data.metrics.avg_daily_sales || 0;
            data.metrics.total_items_sold = data.metrics.total_items_sold || 0;
            data.metrics.avg_daily_items = data.metrics.avg_daily_items || Math.round(data.metrics.total_items_sold / (data.metrics.days_recorded || 1));
            data.expenses = data.expenses || { opex: { breakdown: {} } };

            const updated = new Date(data.last_updated);
            document.getElementById('lastUpdated').textContent =
                `Updated: ${updated.toLocaleDateString('en-IN')} ${updated.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}`;

            // Store globally for detail rendering
            globalFinData = finData;

            // Render expandable detail panels
            if (finData) {
                renderRevenueDetails(finData);
                renderCogsDetails(finData);
                renderOpexDetails(finData);
                renderCapexDetails(finData);
            }

            // Use financial data if available for more accurate metrics
            if (finData && finData.pnl) {
                // Overview metrics from bank statement data
                document.getElementById('totalRevenue').textContent = formatCurrency(finData.pnl.revenue.total);
                document.getElementById('avgDaily').textContent = `${finData.pnl.gross_margin_pct}% gross margin`;
                document.getElementById('totalCogs').textContent = formatCurrency(finData.pnl.cogs.total);
                document.getElementById('cogsSubtext').textContent = `${finData.pnl.cogs_pct}% of revenue`;
                document.getElementById('totalOpex').textContent = formatCurrency(finData.pnl.opex.total);
                const fixedPct = finData.pnl.opex.fixed_total ? Math.round(finData.pnl.opex.fixed_total / finData.pnl.opex.total * 100) : 0;
                document.getElementById('opexSubtext').textContent = `${fixedPct}% fixed, ${100-fixedPct}% variable`;
                document.getElementById('totalCapex').textContent = formatCurrency(finData.capex ? finData.capex.total : finData.pnl.capex);
                document.getElementById('itemsSold').textContent = formatNumber(data.metrics.total_items_sold);
                document.getElementById('avgItems').textContent = `${Math.round(data.metrics.avg_daily_items)} avg/day`;
                document.getElementById('daysRecorded').textContent = finData ? finData.reconciliation.revenue.petpooja_sales > 0 ? 
                    finData.period.days || data.metrics.days_recorded : data.metrics.days_recorded : data.metrics.days_recorded;

                const profit = finData.pnl.net_profit;
                document.getElementById('profitLabel').textContent = 'Net Profit';
                document.getElementById('operatingProfit').textContent = formatCurrency(profit);
                document.getElementById('operatingProfit').className = 'value ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('profitCard').className = 'metric-card ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('marginPct').textContent = `${finData.pnl.operating_margin_pct}% op. margin`;
            } else {
                // Fallback to operational data
                document.getElementById('totalRevenue').textContent = formatCurrency(data.metrics.total_revenue);
                document.getElementById('avgDaily').textContent = `${formatCurrency(data.metrics.avg_daily_revenue)} avg/day`;
                document.getElementById('totalCogs').textContent = '--';
                document.getElementById('cogsSubtext').textContent = 'No data';
                document.getElementById('totalOpex').textContent = formatCurrency(data.metrics.total_opex);
                document.getElementById('totalCapex').textContent = formatCurrency(data.metrics.total_capex);
                document.getElementById('itemsSold').textContent = formatNumber(data.metrics.total_items_sold);
                document.getElementById('avgItems').textContent = `${Math.round(data.metrics.avg_daily_items)} avg/day`;
                document.getElementById('daysRecorded').textContent = finData ? finData.reconciliation.revenue.petpooja_sales > 0 ? 
                    finData.period.days || data.metrics.days_recorded : data.metrics.days_recorded : data.metrics.days_recorded;

                const profit = data.metrics.operating_profit;
                document.getElementById('profitLabel').textContent = 'Operating Profit';
                document.getElementById('operatingProfit').textContent = formatCurrency(profit);
                document.getElementById('operatingProfit').className = 'value ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('profitCard').className = 'metric-card ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('marginPct').textContent =
                    `${data.metrics.gross_margin_pct > 0 ? '+' : ''}${data.metrics.gross_margin_pct}% margin`;
            }

            // Charts
            renderRevenueTrendChart(data.daily_sales);
            renderCategoryChart(data.category_sales);
            if (finData && finData.pnl) {
                renderOpexChart(finData.pnl.opex.breakdown);
            } else {
                renderOpexChart(data.expenses.opex.breakdown);
            }
            renderSalesItemsChart(data.daily_sales);

            // Use financial monthly data if available
            if (finData && finData.monthly) {
                renderMonthlyPnlChart(finData.monthly);
                renderMonthlyPnlTable(finData.monthly);
            } else {
                renderMonthlyPnlChart(data.monthly_pnl);
                renderMonthlyPnlTable(data.monthly_pnl);
            }

            // Tables
            try { renderTopItemsTable(data.top_items); } catch(e) { console.error('TopItems error:', e); }
            try { renderCategoryTable(data.category_sales); } catch(e) { console.error('Category error:', e); }
            try { renderAllItemsTable(data.top_items); } catch(e) { console.error('AllItems error:', e); }
            // Use financial data for expenses (has correct breakdown)
            if (finData && finData.expenses) {
                try { renderExpensesTables(finData.expenses); } catch(e) { console.error('Expenses error:', e); }
            }
            try { renderBalanceSheet(finData); } catch(e) { console.error('BalanceSheet error:', e); }
            try { renderPnlStatement(data, finData); } catch(e) { console.error('PnL error:', e); }

            // New drill-down renderers
            try { updateSalesView(); } catch(e) { console.error('Sales view error:', e); }
            try { renderSalesCategoryDrilldown(); } catch(e) { console.error('Sales category error:', e); }
            try { updateExpenseView(); } catch(e) { console.error('Expense view error:', e); }
            try { renderPartnerDrilldown(); } catch(e) { console.error('Partner error:', e); }

            // Update expense summary cards
            if (finData) {
                document.getElementById('expCogs').textContent = formatCurrency(finData.pnl?.cogs?.total || 0);
                document.getElementById('expOpex').textContent = formatCurrency(finData.pnl?.opex?.total || 0);
                document.getElementById('expCapex').textContent = formatCurrency(finData.capex?.total || 0);
            }
        }

        function renderRevenueTrendChart(dailySales) {
            const isMobile = window.innerWidth < 768;
            // Show fewer data points on mobile
            const sorted = [...dailySales].sort((a, b) => new Date(a.date) - new Date(b.date));
            const displayData = isMobile ? sorted.slice(-14) : sorted;
            const ctx = document.getElementById('revenueTrendChart').getContext('2d');

            if (chartInstances.revenueTrend) chartInstances.revenueTrend.destroy();
            chartInstances.revenueTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: displayData.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Revenue',
                        data: displayData.map(d => d.revenue || d.total_sales),
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '20',
                        fill: true,
                        tension: 0.3,
                        pointRadius: isMobile ? 2 : 3,
                        pointHitRadius: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: v => formatCurrency(v),
                                font: { size: isMobile ? 10 : 12 }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: isMobile ? 9 : 11 },
                                maxTicksLimit: isMobile ? 7 : 15
                            }
                        }
                    }
                }
            });
        }

        function renderCategoryChart(categorySales) {
            const categories = Object.entries(categorySales).sort((a, b) => b[1].revenue - a[1].revenue);
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const isMobile = window.innerWidth < 768;

            if (chartInstances.category) chartInstances.category.destroy();
            chartInstances.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories.map(([name]) => name),
                    datasets: [{
                        data: categories.map(([, d]) => d.revenue),
                        backgroundColor: colors.chart,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: isMobile ? 'bottom' : 'right',
                            labels: {
                                boxWidth: isMobile ? 10 : 12,
                                padding: isMobile ? 8 : 10,
                                font: { size: isMobile ? 11 : 12 }
                            }
                        }
                    }
                }
            });
        }

        function renderOpexChart(opexByCategory) {
            const isMobile = window.innerWidth < 768;
            const categories = Object.entries(opexByCategory).sort((a, b) => b[1] - a[1]).slice(0, isMobile ? 5 : 7);
            const ctx = document.getElementById('opexChart').getContext('2d');

            if (chartInstances.opex) chartInstances.opex.destroy();
            chartInstances.opex = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(([name]) => name.replace(' (partner-paid)', '').substring(0, 12)),
                    datasets: [{
                        data: categories.map(([, v]) => v),
                        backgroundColor: colors.chart,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            ticks: {
                                callback: v => formatCurrency(v),
                                font: { size: isMobile ? 10 : 12 }
                            }
                        },
                        y: {
                            ticks: {
                                font: { size: isMobile ? 10 : 12 }
                            }
                        }
                    }
                }
            });
        }

        function renderSalesItemsChart(dailySales) {
            const sorted = [...dailySales].sort((a, b) => new Date(a.date) - new Date(b.date));
            const ctx = document.getElementById('salesItemsChart').getContext('2d');

            if (chartInstances.salesItems) chartInstances.salesItems.destroy();
            chartInstances.salesItems = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Revenue',
                        data: sorted.map(d => d.revenue || d.total_sales),
                        backgroundColor: colors.primary,
                        yAxisID: 'y'
                    }, {
                        label: 'Items Sold',
                        data: sorted.map(d => d.items_sold || 0),
                        type: 'line',
                        borderColor: colors.success,
                        backgroundColor: 'transparent',
                        yAxisID: 'y1',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', ticks: { callback: v => formatCurrency(v) } },
                        y1: { position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function renderMonthlyPnlChart(monthlyPnl) {
            const ctx = document.getElementById('monthlyPnlChart').getContext('2d');
            const isMobile = window.innerWidth < 768;
            const hasCogs = monthlyPnl.some(m => m.cogs !== undefined);

            if (chartInstances.monthlyPnl) chartInstances.monthlyPnl.destroy();
            chartInstances.monthlyPnl = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyPnl.map(m => m.month),
                    datasets: hasCogs ? [
                        {
                            label: 'Revenue',
                            data: monthlyPnl.map(m => m.revenue),
                            backgroundColor: colors.primary
                        }, {
                            label: 'COGS',
                            data: monthlyPnl.map(m => m.cogs || 0),
                            backgroundColor: colors.secondary
                        }, {
                            label: 'OpEx',
                            data: monthlyPnl.map(m => m.opex),
                            backgroundColor: colors.warning
                        }, {
                            label: 'Profit',
                            data: monthlyPnl.map(m => m.operating_profit),
                            backgroundColor: monthlyPnl.map(m => m.operating_profit >= 0 ? colors.success : colors.danger)
                        }
                    ] : [
                        {
                            label: 'Revenue',
                            data: monthlyPnl.map(m => m.revenue),
                            backgroundColor: colors.primary
                        }, {
                            label: 'OpEx',
                            data: monthlyPnl.map(m => m.opex),
                            backgroundColor: colors.warning
                        }, {
                            label: 'Profit',
                            data: monthlyPnl.map(m => m.operating_profit),
                            backgroundColor: monthlyPnl.map(m => m.operating_profit >= 0 ? colors.success : colors.danger)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: isMobile ? 'bottom' : 'top',
                            labels: {
                                boxWidth: isMobile ? 10 : 12,
                                padding: isMobile ? 6 : 10,
                                font: { size: isMobile ? 10 : 12 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: v => formatCurrency(v),
                                font: { size: isMobile ? 10 : 12 }
                            }
                        },
                        x: {
                            ticks: {
                                font: { size: isMobile ? 10 : 12 }
                            }
                        }
                    }
                }
            });
        }

        function renderTopItemsTable(topItems) {
            document.getElementById('topItemsTable').innerHTML = topItems.slice(0, 15).map((item, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${item.item}</td>
                    <td><span class="category-badge">${item.category}</span></td>
                    <td class="right">${formatNumber(item.qty)}</td>
                    <td class="right">${formatCurrency(item.revenue)}</td>
                </tr>
            `).join('');
        }

        function renderCategoryTable(categorySales) {
            const sorted = Object.entries(categorySales).sort((a, b) => b[1].revenue - a[1].revenue);
            const total = sorted.reduce((sum, [, d]) => sum + d.revenue, 0);

            document.getElementById('categoryTable').innerHTML = sorted.map(([name, data]) => `
                <tr>
                    <td>${name}</td>
                    <td class="right">${formatNumber(data.qty)}</td>
                    <td class="right">${formatCurrency(data.revenue)}</td>
                </tr>
            `).join('') + `
                <tr class="total-row">
                    <td>Total</td>
                    <td class="right">${formatNumber(sorted.reduce((s, [,d]) => s + d.qty, 0))}</td>
                    <td class="right">${formatCurrency(total)}</td>
                </tr>
            `;
        }

        function renderAllItemsTable(items) {
            document.getElementById('allItemsTable').innerHTML = items.map(item => `
                <tr>
                    <td>${item.item}</td>
                    <td class="right">${formatNumber(item.qty)}</td>
                    <td class="right">${formatCurrency(item.revenue)}</td>
                </tr>
            `).join('');
        }

        function renderMonthlyPnlTable(monthlyPnl) {
            // Handle both old format (without cogs) and new format (with cogs)
            document.getElementById('monthlyPnlTable').innerHTML = monthlyPnl.map(m => {
                const cogs = m.cogs !== undefined ? m.cogs : 0;
                const grossProfit = m.gross_profit !== undefined ? m.gross_profit : m.revenue;
                return `
                    <tr>
                        <td>${m.month}</td>
                        <td class="right">${formatCurrency(m.revenue)}</td>
                        <td class="right">${formatCurrency(cogs)}</td>
                        <td class="right" style="color:${grossProfit >= 0 ? '#22c55e' : '#ef4444'}">${formatCurrency(grossProfit)}</td>
                        <td class="right">${formatCurrency(m.opex)}</td>
                        <td class="right" style="color:${m.operating_profit >= 0 ? '#22c55e' : '#ef4444'}">${formatCurrency(m.operating_profit)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderExpensesTables(expenses) {
            document.getElementById('expTotal').textContent = formatCurrency(expenses.total);
            document.getElementById('expOpex').textContent = formatCurrency(expenses.opex.total);
            document.getElementById('expCapex').textContent = formatCurrency(expenses.capex.total);

            const capexSorted = Object.entries(expenses.capex.by_category).sort((a, b) => b[1] - a[1]);
            document.getElementById('capexTable').innerHTML = capexSorted.map(([name, amount]) => `
                <tr><td>${name}</td><td class="right">${formatCurrency(amount)}</td></tr>
            `).join('') + `
                <tr class="total-row"><td>Total CapEx</td><td class="right">${formatCurrency(expenses.capex.total)}</td></tr>
            `;

            const opexSorted = Object.entries(expenses.opex.breakdown).sort((a, b) => b[1] - a[1]);
            document.getElementById('opexTable').innerHTML = opexSorted.map(([name, amount]) => `
                <tr><td>${name}</td><td class="right">${formatCurrency(amount)}</td></tr>
            `).join('') + `
                <tr class="total-row"><td>Total OpEx</td><td class="right">${formatCurrency(expenses.opex.total)}</td></tr>
            `;

            // Partner contributions (from capex by_partner if available)
            const partnerData = expenses.by_partner || {};
            const partnerSorted = Object.entries(partnerData).sort((a, b) => b[1] - a[1]);
            if (partnerSorted.length > 0) {
                document.getElementById('partnerTable').innerHTML = partnerSorted.map(([name, amount]) => `
                    <tr><td>${name}</td><td class="right">${formatCurrency(amount)}</td></tr>
                `).join('') + `
                    <tr class="total-row"><td>Total</td><td class="right">${formatCurrency(Object.values(partnerData).reduce((a,b) => a+b, 0))}</td></tr>
                `;
            } else {
                document.getElementById('partnerTable').innerHTML = '<tr><td colspan="2" style="color:#64748b">Partner breakdown not available</td></tr>';
            }
        }

        function renderBalanceSheet(finData) {
            if (!finData || !finData.balance_sheet) return;
            
            const bs = finData.balance_sheet;
            
            // Summary metrics
            document.getElementById('bsAssets').textContent = formatCurrency(bs.assets.total);
            document.getElementById('bsLiabilities').textContent = formatCurrency(bs.liabilities.total);
            document.getElementById('bsEquity').textContent = formatCurrency(bs.equity.total);
            document.getElementById('bsAsOf').textContent = bs.as_of;
            
            // Assets table
            let assetsHtml = '';
            assetsHtml += '<tr class="section-header"><td colspan="2"><strong>Current Assets</strong></td></tr>';
            assetsHtml += '<tr><td class="indent">Cash & Bank</td><td class="right">' + formatCurrency(bs.assets.current.cash) + '</td></tr>';
            if (bs.assets.current.receivables > 0) {
                assetsHtml += '<tr><td class="indent">Receivables</td><td class="right">' + formatCurrency(bs.assets.current.receivables) + '</td></tr>';
            }
            
            if (bs.assets.non_current && bs.assets.non_current.security_deposits > 0) {
                assetsHtml += '<tr class="section-header"><td colspan="2"><strong>Non-Current Assets</strong></td></tr>';
                assetsHtml += '<tr><td class="indent">Security Deposits</td><td class="right">' + formatCurrency(bs.assets.non_current.security_deposits) + '</td></tr>';
            }
            
            assetsHtml += '<tr class="section-header"><td colspan="2"><strong>Fixed Assets</strong></td></tr>';
            assetsHtml += '<tr><td class="indent">Equipment</td><td class="right">' + formatCurrency(bs.assets.fixed.equipment) + '</td></tr>';
            assetsHtml += '<tr><td class="indent">Furniture</td><td class="right">' + formatCurrency(bs.assets.fixed.furniture) + '</td></tr>';
            assetsHtml += '<tr><td class="indent">Interior</td><td class="right">' + formatCurrency(bs.assets.fixed.interior) + '</td></tr>';
            assetsHtml += '<tr class="total-row"><td><strong>Total Assets</strong></td><td class="right"><strong>' + formatCurrency(bs.assets.total) + '</strong></td></tr>';
            
            document.getElementById('assetsTable').innerHTML = assetsHtml;
            
            // Liabilities & Equity table
            let liabHtml = '';
            liabHtml += '<tr class="section-header"><td colspan="2"><strong>Current Liabilities</strong></td></tr>';
            liabHtml += '<tr><td class="indent">Accounts Payable</td><td class="right">' + formatCurrency(bs.liabilities.current.accounts_payable) + '</td></tr>';
            liabHtml += '<tr class="subtotal-row"><td>Total Liabilities</td><td class="right">' + formatCurrency(bs.liabilities.total) + '</td></tr>';
            
            liabHtml += '<tr class="section-header"><td colspan="2"><strong>Equity</strong></td></tr>';
            liabHtml += '<tr><td class="indent">Partner Capital</td><td class="right">' + formatCurrency(bs.equity.partner_capital) + '</td></tr>';
            liabHtml += '<tr class="total-row"><td><strong>Total Liabilities + Equity</strong></td><td class="right"><strong>' + formatCurrency(bs.liabilities.total + bs.equity.total) + '</strong></td></tr>';
            
            document.getElementById('liabilitiesTable').innerHTML = liabHtml;
        }

        function renderPnlStatement(data, finData) {
            if (finData && finData.pnl) {
                // Use financial data from bank statement
                const pnl = finData.pnl;

                // Period
                document.getElementById('pnlPeriod').textContent =
                    `Period: ${pnl.period.start} to ${pnl.period.end}`;

                // Revenue breakdown
                const revenueLines = Object.entries(pnl.revenue.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlRevenueLines').innerHTML = revenueLines;
                document.getElementById('pnlTotalRevenue').textContent = formatCurrency(pnl.revenue.total);

                // COGS breakdown
                const cogsLines = Object.entries(pnl.cogs.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlCogsLines').innerHTML = cogsLines;
                document.getElementById('pnlTotalCogs').textContent = formatCurrency(pnl.cogs.total);

                // Gross profit
                document.getElementById('pnlGrossProfit').textContent = formatCurrency(pnl.gross_profit);
                document.getElementById('pnlGrossProfit').style.color = pnl.gross_profit >= 0 ? '#22c55e' : '#ef4444';
                document.getElementById('pnlGrossMargin').textContent = `${pnl.gross_margin_pct}%`;

                // OpEx breakdown
                const opexLines = Object.entries(pnl.opex.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlOpexLines').innerHTML = opexLines;
                document.getElementById('pnlTotalOpex').textContent = formatCurrency(pnl.opex.total);

                // Operating profit
                document.getElementById('pnlOperatingProfit').textContent = formatCurrency(pnl.operating_profit);
                document.getElementById('pnlOperatingProfit').style.color = pnl.operating_profit >= 0 ? '#22c55e' : '#ef4444';
                document.getElementById('pnlOpMargin').textContent = `${pnl.operating_margin_pct}%`;

                // Other expenses
                document.getElementById('pnlOtherExpenses').textContent = formatCurrency(pnl.other_expenses);

                // Net profit
                document.getElementById('pnlNetProfit').textContent = formatCurrency(pnl.net_profit);
                document.getElementById('pnlNetProfit').style.color = pnl.net_profit >= 0 ? '#22c55e' : '#ef4444';

                // Render vendor table
                if (finData.vendors) {
                    const vendorRows = finData.vendors.slice(0, 15).map(v => `
                        <tr>
                            <td>${v.vendor}</td>
                            <td><span class="category-badge">${v.category}</span></td>
                            <td class="right">${formatCurrency(v.total)}</td>
                        </tr>
                    `).join('');
                    document.getElementById('vendorTable').innerHTML = vendorRows;
                }
            } else {
                // Fallback to operational data
                document.getElementById('pnlPeriod').textContent = '';
                document.getElementById('pnlRevenueLines').innerHTML = `
                    <div class="pnl-row indent">
                        <span>Sales Revenue</span>
                        <span>${formatCurrency(data.pnl_summary.revenue)}</span>
                    </div>
                `;
                document.getElementById('pnlTotalRevenue').textContent = formatCurrency(data.pnl_summary.revenue);
                document.getElementById('pnlCogsLines').innerHTML = '<div class="pnl-row indent"><span>No COGS data</span><span>--</span></div>';
                document.getElementById('pnlTotalCogs').textContent = '--';
                document.getElementById('pnlGrossProfit').textContent = '--';
                document.getElementById('pnlGrossMargin').textContent = '--';

                const opexLines = Object.entries(data.expenses.opex.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlOpexLines').innerHTML = opexLines;
                document.getElementById('pnlTotalOpex').textContent = formatCurrency(data.pnl_summary.operating_expenses);

                const profit = data.pnl_summary.operating_profit;
                document.getElementById('pnlOperatingProfit').textContent = formatCurrency(profit);
                document.getElementById('pnlOperatingProfit').style.color = profit >= 0 ? '#22c55e' : '#ef4444';
                document.getElementById('pnlOpMargin').textContent = '--';
                document.getElementById('pnlOtherExpenses').textContent = '--';
                document.getElementById('pnlNetProfit').textContent = formatCurrency(profit);
                document.getElementById('pnlNetProfit').style.color = profit >= 0 ? '#22c55e' : '#ef4444';
            }
        }

        // ============================================
        // REFRESH DATA FUNCTIONALITY
        // ============================================
        const API_URL = 'http://localhost:5050';
        let refreshCheckInterval = null;

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const statusEl = document.getElementById('refreshStatus');

            // Update button state
            btn.disabled = true;
            btn.classList.add('loading');
            btn.querySelector('.refresh-text').textContent = 'Fetching...';
            statusEl.textContent = 'Connecting to server...';
            statusEl.className = 'refresh-status';

            try {
                // Trigger update
                const response = await fetch(`${API_URL}/update`, { method: 'POST' });
                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.textContent = 'Update started, fetching emails...';
                    // Start polling for completion
                    startStatusPolling();
                } else {
                    throw new Error(data.message || 'Failed to start update');
                }
            } catch (error) {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.querySelector('.refresh-text').textContent = 'Refresh Data';
                statusEl.textContent = 'Error: ' + (error.message.includes('Failed to fetch')
                    ? 'API server not running. Start with: python api_server.py'
                    : error.message);
                statusEl.className = 'refresh-status error';
            }
        }

        function startStatusPolling() {
            // Poll every 2 seconds for status
            refreshCheckInterval = setInterval(checkRefreshStatus, 2000);
        }

        async function checkRefreshStatus() {
            const btn = document.getElementById('refreshBtn');
            const statusEl = document.getElementById('refreshStatus');

            try {
                const response = await fetch(`${API_URL}/status`);
                const status = await response.json();

                if (!status.running) {
                    // Update complete
                    clearInterval(refreshCheckInterval);
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    btn.querySelector('.refresh-text').textContent = 'Refresh Data';

                    if (status.last_result && status.last_result.success) {
                        statusEl.textContent = 'Update complete! Reloading...';
                        statusEl.className = 'refresh-status success';
                        // Reload dashboard data
                        setTimeout(() => {
                            loadDashboard();
                            statusEl.textContent = 'Data refreshed successfully';
                        }, 1000);
                    } else {
                        statusEl.textContent = 'Update failed: ' + (status.last_error || 'Unknown error');
                        statusEl.className = 'refresh-status error';
                    }
                } else {
                    statusEl.textContent = 'Processing... please wait';
                }
            } catch (error) {
                // Server might be busy, continue polling
            }
        }

        // Check if API server is available on load
        async function checkApiServer() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('refreshBtn').style.display = 'flex';
                }
            } catch {
                // API server not running - button still visible but will show error
            }
        }

        loadDashboard();
        checkApiServer();

        // ============================================
        // MENU COSTS TAB
        // ============================================
        let globalMenuCostsData = null;
        let currentMenuCategory = 'all';

        function renderMenuCosts(data) {
            globalMenuCostsData = data;

            // Summary cards
            document.getElementById('menuAvgMargin').textContent = data.overall_avg_margin_pct + '%';
            document.getElementById('menuFoodCost').textContent = data.overall_avg_food_cost_pct + '%';
            document.getElementById('menuTotalItems').textContent = data.total_items;

            // Render charts
            renderMarginByCategoryChart(data.category_summary);
            renderBestMarginsChart(data.best_margins);

            // Render tables
            renderMenuCostsTable(data.items);
            renderWorstMarginsTable(data.worst_margins);
        }

        function filterMenuCategory(category) {
            currentMenuCategory = category;

            // Update button states
            document.querySelectorAll('[data-menu-cat]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.menuCat === category);
            });

            if (globalMenuCostsData) {
                const filteredItems = category === 'all'
                    ? globalMenuCostsData.items
                    : globalMenuCostsData.items.filter(i => i.category === category);
                renderMenuCostsTable(filteredItems);
            }
        }

        function renderMarginByCategoryChart(categorySummary) {
            const ctx = document.getElementById('marginByCategoryChart');
            if (!ctx) return;

            if (chartInstances.marginByCategory) {
                chartInstances.marginByCategory.destroy();
            }

            const sortedCats = categorySummary.sort((a, b) => b.avg_margin_pct - a.avg_margin_pct);

            chartInstances.marginByCategory = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCats.map(c => c.category),
                    datasets: [{
                        label: 'Avg Margin %',
                        data: sortedCats.map(c => c.avg_margin_pct),
                        backgroundColor: sortedCats.map(c =>
                            c.avg_margin_pct >= 60 ? colors.success :
                            c.avg_margin_pct >= 50 ? colors.primary :
                            c.avg_margin_pct >= 40 ? colors.warning : colors.danger
                        ),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.raw.toFixed(1)}% margin`
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }

        function renderBestMarginsChart(bestMargins) {
            const ctx = document.getElementById('bestMarginsChart');
            if (!ctx) return;

            if (chartInstances.bestMargins) {
                chartInstances.bestMargins.destroy();
            }

            chartInstances.bestMargins = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bestMargins.map(i => i.name.length > 20 ? i.name.substring(0, 18) + '...' : i.name),
                    datasets: [{
                        label: 'Margin %',
                        data: bestMargins.map(i => i.margin_pct),
                        backgroundColor: colors.success,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const item = bestMargins[ctx.dataIndex];
                                    return `₹${item.price} - Cost: ₹${item.cost} = ${item.margin_pct}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: v => v + '%' }
                        }
                    }
                }
            });
        }

        function renderMenuCostsTable(items) {
            const tbody = document.getElementById('menuCostsTable');
            if (!tbody) return;

            const sortedItems = [...items].sort((a, b) => b.margin_pct - a.margin_pct);

            tbody.innerHTML = sortedItems.map(item => {
                const marginColor = item.margin_pct >= 60 ? 'var(--success)' :
                                   item.margin_pct >= 50 ? 'var(--text-primary)' :
                                   item.margin_pct >= 40 ? 'var(--warning)' : 'var(--danger)';
                return `
                    <tr>
                        <td>${item.name}</td>
                        <td style="color:var(--text-muted);font-size:0.75rem">${item.category}</td>
                        <td class="right">₹${item.price}</td>
                        <td class="right">₹${item.cost.toFixed(1)}</td>
                        <td class="right">₹${item.margin.toFixed(1)}</td>
                        <td class="right" style="color:${marginColor};font-weight:600">${item.margin_pct}%</td>
                    </tr>
                `;
            }).join('');
        }

        function renderWorstMarginsTable(worstMargins) {
            const tbody = document.getElementById('worstMarginsTable');
            if (!tbody) return;

            tbody.innerHTML = worstMargins.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td style="color:var(--text-muted);font-size:0.75rem">${item.category}</td>
                    <td class="right">₹${item.price}</td>
                    <td class="right">₹${item.cost}</td>
                    <td class="right" style="color:var(--warning);font-weight:600">${item.margin_pct}%</td>
                </tr>
            `).join('');
        }

        // ============================================
        // INVENTORY TAB
        // ============================================
        function renderInventory(data) {
            // Summary cards
            document.getElementById('invTotalOrders').textContent = formatNumber(data.summary.total_orders_analyzed);
            document.getElementById('invMatchRate').textContent = data.summary.match_rate + '%';
            document.getElementById('invIngredients').textContent = data.summary.unique_ingredients;
            document.getElementById('invTotalCost').textContent = formatCurrency(data.summary.total_ingredient_cost);

            // Source note
            if (data.period && data.period.source) {
                document.getElementById('invSourceNote').textContent = `Source: ${data.period.source}`;
            }

            // Render chart
            renderIngredientUsageChart(data.top_ingredients);

            // Render table
            renderIngredientUsageTable(data.all_ingredients);

            // Render unmatched items
            if (data.unmatched_items && data.unmatched_items.length > 0) {
                document.getElementById('unmatchedItemsList').textContent = data.unmatched_items.join(', ');
            } else {
                document.getElementById('unmatchedItemsList').textContent = 'All items matched!';
            }
        }

        function renderIngredientUsageChart(topIngredients) {
            const ctx = document.getElementById('ingredientUsageChart');
            if (!ctx) return;

            if (chartInstances.ingredientUsage) {
                chartInstances.ingredientUsage.destroy();
            }

            chartInstances.ingredientUsage = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topIngredients.map(i => i.ingredient),
                    datasets: [{
                        label: 'Usage (kg)',
                        data: topIngredients.map(i => i.total_kg),
                        backgroundColor: colors.primary,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const item = topIngredients[ctx.dataIndex];
                                    return `${item.total_kg} kg (${item.orders_using} orders)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: v => v + ' kg' }
                        }
                    }
                }
            });
        }

        function renderIngredientUsageTable(ingredients) {
            const tbody = document.getElementById('ingredientUsageTable');
            if (!tbody) return;

            tbody.innerHTML = ingredients.map(ing => `
                <tr>
                    <td>${ing.ingredient}</td>
                    <td class="right">${ing.total_kg.toFixed(2)}</td>
                    <td class="right">${formatNumber(ing.orders_using)}</td>
                    <td class="right">${ing.cost_per_kg ? '₹' + ing.cost_per_kg : '-'}</td>
                    <td class="right">${ing.total_cost ? '₹' + ing.total_cost.toFixed(0) : '-'}</td>
                </tr>
            `).join('');
        }

        // ============================================
        // MOBILE NAVIGATION
        // ============================================
        function initMobileNav() {
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.dataset.tab;

                    // Update mobile nav active state
                    document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    // Update desktop tabs active state
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    const desktopTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
                    if (desktopTab) desktopTab.classList.add('active');

                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        initMobileNav();
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav">
        <button class="mobile-nav-item active" data-tab="overview">
            <span class="mobile-nav-icon">📊</span>
            <span class="mobile-nav-label">Home</span>
        </button>
        <button class="mobile-nav-item" data-tab="sales">
            <span class="mobile-nav-icon">📈</span>
            <span class="mobile-nav-label">Sales</span>
        </button>
        <button class="mobile-nav-item" data-tab="menu-costs">
            <span class="mobile-nav-icon">🍽️</span>
            <span class="mobile-nav-label">Menu</span>
        </button>
        <button class="mobile-nav-item" data-tab="financials">
            <span class="mobile-nav-icon">📄</span>
            <span class="mobile-nav-label">P&L</span>
        </button>
        <button class="mobile-nav-item" data-tab="expenses">
            <span class="mobile-nav-icon">💰</span>
            <span class="mobile-nav-label">Costs</span>
        </button>
    </nav>
</body>
</html>
