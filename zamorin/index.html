<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Zamorins - Restaurant Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f8fafc;
        }

        .header .subtitle {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .last-updated {
            color: #64748b;
            font-size: 0.75rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #16a34a;
        }

        .refresh-btn:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .refresh-status {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .refresh-status.success {
            color: #22c55e;
        }

        .refresh-status.error {
            color: #ef4444;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #334155;
            padding-bottom: 1rem;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab:hover {
            background: #334155;
            color: #f8fafc;
        }

        .tab.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .period-selector {
            display: flex;
            gap: 0.5rem;
        }

        .period-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .period-btn:hover {
            background: #334155;
            color: #f8fafc;
        }

        .period-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: #fff;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #334155;
        }

        .metric-card.highlight {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #1e293b 0%, #1e3a5f 100%);
        }

        .metric-card.positive {
            border-color: #22c55e;
        }

        .metric-card.negative {
            border-color: #ef4444;
        }

        .metric-card .label {
            color: #94a3b8;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .metric-card .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f8fafc;
        }

        .metric-card .value.positive {
            color: #22c55e;
        }

        .metric-card .value.negative {
            color: #ef4444;
        }

        .metric-card .subtext {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #334155;
        }

        .chart-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 1rem;
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Tables */
        .table-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #334155;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .table-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 1rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 0.75rem;
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #334155;
        }

        .data-table th.right {
            text-align: right;
        }

        .data-table td {
            padding: 0.75rem;
            font-size: 0.875rem;
            border-bottom: 1px solid #334155;
        }

        .data-table td.right {
            text-align: right;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: #334155;
        }

        .data-table .total-row {
            font-weight: 600;
            background: #334155;
        }

        .data-table .total-row td {
            border-top: 2px solid #475569;
        }

        .data-table .section-header td {
            background: #1e293b;
            padding-top: 1rem;
            border-bottom: none;
        }

        .data-table .subtotal-row {
            background: #1e293b;
        }

        .data-table .subtotal-row td {
            border-top: 1px solid #475569;
        }

        .data-table .indent {
            padding-left: 1.5rem;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            background: #334155;
            color: #94a3b8;
        }

        /* P&L Specific */
        .pnl-section {
            margin-bottom: 1rem;
        }

        .pnl-section h4 {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #334155;
        }

        .pnl-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }

        .pnl-row.indent {
            padding-left: 1rem;
            color: #94a3b8;
        }

        .pnl-row.total {
            font-weight: 600;
            border-top: 1px solid #475569;
            margin-top: 0.5rem;
            padding-top: 0.75rem;
        }

        .pnl-row.grand-total {
            font-size: 1rem;
            font-weight: 700;
            border-top: 2px solid #475569;
            margin-top: 0.5rem;
            padding-top: 0.75rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #64748b;
        }

        /* Two column layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }

        /* Expandable Metric Cards */
        .metric-card.expandable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .metric-card.expandable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .metric-card .expand-icon {
            float: right;
            color: #64748b;
            font-size: 0.75rem;
            transition: transform 0.2s;
        }

        .metric-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .metric-card .detail-panel {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
        }

        .metric-card.expanded .detail-panel {
            display: block;
        }

        .detail-panel .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .detail-panel .view-btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.7rem;
            border: 1px solid #475569;
            background: transparent;
            color: #94a3b8;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .detail-panel .view-btn:hover {
            background: #334155;
        }

        .detail-panel .view-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            font-size: 0.75rem;
            border-bottom: 1px solid #334155;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row .label {
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: none;
            letter-spacing: normal;
        }

        .detail-row .amount {
            font-family: 'SF Mono', Monaco, monospace;
            color: #e2e8f0;
        }

        .detail-row.sub-item {
            padding-left: 1rem;
            font-size: 0.7rem;
        }

        .detail-row.sub-item .label {
            color: #64748b;
        }

        .detail-section-title {
            font-size: 0.65rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px dashed #475569;
        }

        .badge-fixed {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            font-size: 0.6rem;
            background: #1e3a5f;
            color: #60a5fa;
            border-radius: 3px;
            margin-left: 0.5rem;
        }

        .badge-variable {
            display: inline-block;
            padding: 0.1rem 0.4rem;
            font-size: 0.6rem;
            background: #3f3f1e;
            color: #fbbf24;
            border-radius: 3px;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div>
            <h1>The Zamorins</h1>
            <div class="subtitle">Restaurant Analytics Dashboard</div>
        </div>
        <div class="header-actions">
            <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                <span class="refresh-icon">&#8635;</span>
                <span class="refresh-text">Refresh Data</span>
            </button>
            <div>
                <div class="last-updated" id="lastUpdated">Loading...</div>
                <div class="refresh-status" id="refreshStatus"></div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="sales">Sales Analysis</button>
            <button class="tab" data-tab="financials">P&L Statement</button>
            <button class="tab" data-tab="expenses">Expenses</button>
            <button class="tab" data-tab="balance-sheet">Balance Sheet</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <!-- Period Selector -->
            <div class="period-selector" style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
                <button class="period-btn active" data-period="all" onclick="setPeriod('all')">All Time</button>
                <button class="period-btn" data-period="month" onclick="setPeriod('month')">This Month</button>
                <button class="period-btn" data-period="week" onclick="setPeriod('week')">This Week</button>
            </div>
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card highlight expandable" id="revenueCard" onclick="toggleExpand('revenueCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Total Revenue</div>
                    <div class="value" id="totalRevenue">--</div>
                    <div class="subtext" id="avgDaily">-- avg/day</div>
                    <div class="detail-panel" id="revenueDetails"></div>
                </div>
                <div class="metric-card expandable" id="cogsCard" onclick="toggleExpand('cogsCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Cost of Goods Sold</div>
                    <div class="value" id="totalCogs">--</div>
                    <div class="subtext" id="cogsSubtext">Food costs</div>
                    <div class="detail-panel" id="cogsDetails"></div>
                </div>
                <div class="metric-card expandable" id="opexCard" onclick="toggleExpand('opexCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Operating Expenses</div>
                    <div class="value" id="totalOpex">--</div>
                    <div class="subtext" id="opexSubtext">Recurring costs</div>
                    <div class="detail-panel" id="opexDetails"></div>
                </div>
                <div class="metric-card" id="profitCard">
                    <div class="label" id="profitLabel">Net Profit</div>
                    <div class="value" id="operatingProfit">--</div>
                    <div class="subtext" id="marginPct">-- margin</div>
                </div>
                <div class="metric-card">
                    <div class="label">Items Sold</div>
                    <div class="value" id="itemsSold">--</div>
                    <div class="subtext" id="avgItems">-- avg/day</div>
                </div>
                <div class="metric-card expandable" id="capexCard" onclick="toggleExpand('capexCard')">
                    <span class="expand-icon">▼</span>
                    <div class="label">Capital Investment</div>
                    <div class="value" id="totalCapex">--</div>
                    <div class="subtext">One-time setup</div>
                    <div class="detail-panel" id="capexDetails"></div>
                </div>
                <div class="metric-card">
                    <div class="label">Days Recorded</div>
                    <div class="value" id="daysRecorded">--</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card full-width">
                    <h3>Daily Revenue Trend</h3>
                    <div class="chart-container">
                        <canvas id="revenueTrendChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Sales by Category</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Operating Expenses Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="opexChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-card">
                <h3>Top Selling Items</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width:40px">#</th>
                            <th>Item</th>
                            <th>Category</th>
                            <th class="right">Qty</th>
                            <th class="right">Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="topItemsTable">
                        <tr><td colspan="5" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Analysis Tab -->
        <div id="sales" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card full-width">
                    <h3>Daily Sales & Items Sold</h3>
                    <div class="chart-container">
                        <canvas id="salesItemsChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="table-card">
                    <h3>Category Performance</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="right">Qty Sold</th>
                                <th class="right">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTable"></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <h3>All Items Performance</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="right">Qty</th>
                                <th class="right">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="allItemsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- P&L Statement Tab -->
        <div id="financials" class="tab-content">
            <div class="two-col">
                <div class="table-card">
                    <h3>Profit & Loss Statement</h3>
                    <div class="subtext" id="pnlPeriod" style="color:#64748b;font-size:0.75rem;margin-bottom:1rem;">Period: --</div>
                    <div id="pnlStatement">
                        <div class="pnl-section">
                            <h4>Revenue</h4>
                            <div id="pnlRevenueLines"></div>
                            <div class="pnl-row total">
                                <span>Total Revenue</span>
                                <span id="pnlTotalRevenue">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <h4>Cost of Goods Sold (COGS)</h4>
                            <div id="pnlCogsLines"></div>
                            <div class="pnl-row total">
                                <span>Total COGS</span>
                                <span id="pnlTotalCogs">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <div class="pnl-row total" style="background:#1e3a5f;padding:0.75rem;border-radius:6px;">
                                <span>Gross Profit</span>
                                <span id="pnlGrossProfit">--</span>
                            </div>
                            <div class="pnl-row indent" style="font-size:0.75rem;">
                                <span>Gross Margin</span>
                                <span id="pnlGrossMargin">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <h4>Operating Expenses</h4>
                            <div id="pnlOpexLines"></div>
                            <div class="pnl-row total">
                                <span>Total Operating Expenses</span>
                                <span id="pnlTotalOpex">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <div class="pnl-row total" style="background:#1e3a5f;padding:0.75rem;border-radius:6px;">
                                <span>Operating Profit</span>
                                <span id="pnlOperatingProfit">--</span>
                            </div>
                            <div class="pnl-row indent" style="font-size:0.75rem;">
                                <span>Operating Margin</span>
                                <span id="pnlOpMargin">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <h4>Other Expenses</h4>
                            <div class="pnl-row indent">
                                <span>Uncategorized / Other</span>
                                <span id="pnlOtherExpenses">--</span>
                            </div>
                        </div>

                        <div class="pnl-section">
                            <div class="pnl-row grand-total" id="pnlProfitRow">
                                <span>Net Profit / (Loss)</span>
                                <span id="pnlNetProfit">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-card">
                    <h3>Monthly P&L Trend</h3>
                    <div class="chart-container">
                        <canvas id="monthlyPnlChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="two-col">
                <div class="table-card">
                    <h3>Monthly Breakdown</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="right">Revenue</th>
                                <th class="right">COGS</th>
                                <th class="right">Gross Profit</th>
                                <th class="right">OpEx</th>
                                <th class="right">Op. Profit</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyPnlTable"></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <h3>Top Vendors by Spend</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Vendor</th>
                                <th>Type</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="vendorTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div id="expenses" class="tab-content">
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="label">Total Expenses</div>
                    <div class="value" id="expTotal">--</div>
                </div>
                <div class="metric-card">
                    <div class="label">Operating (OpEx)</div>
                    <div class="value" id="expOpex">--</div>
                    <div class="subtext">Recurring costs</div>
                </div>
                <div class="metric-card">
                    <div class="label">Capital (CapEx)</div>
                    <div class="value" id="expCapex">--</div>
                    <div class="subtext">One-time investments</div>
                </div>
            </div>

            <div class="two-col">
                <div class="table-card">
                    <h3>Capital Expenditure (CapEx)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="capexTable"></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <h3>Operating Expenses (OpEx)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="opexTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <h3>Partner Contributions</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Partner</th>
                            <th class="right">Amount Paid</th>
                        </tr>
                    </thead>
                    <tbody id="partnerTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Balance Sheet Tab -->
        <div id="balance-sheet" class="tab-content">
            <div class="metrics-grid">
                <div class="metric-card highlight">
                    <div class="label">Total Assets</div>
                    <div class="value" id="bsAssets">--</div>
                </div>
                <div class="metric-card">
                    <div class="label">Total Liabilities</div>
                    <div class="value" id="bsLiabilities">--</div>
                </div>
                <div class="metric-card">
                    <div class="label">Equity</div>
                    <div class="value" id="bsEquity">--</div>
                </div>
            </div>

            <div class="two-col">
                <div class="table-card">
                    <h3>Assets</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="assetsTable"></tbody>
                    </table>
                </div>

                <div class="table-card">
                    <h3>Liabilities & Equity</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="right">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="liabilitiesTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <p class="subtext" style="padding: 1rem; color: #64748b;">
                    As of <span id="bsAsOf">--</span> | 
                    Security Deposits are recoverable assets (not expenses)
                </p>
            </div>
        </div>
    </div>

    <script>
        // Chart.js global defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';

        const colors = {
            primary: '#3b82f6',
            secondary: '#8b5cf6',
            success: '#22c55e',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#06b6d4',
            chart: ['#3b82f6', '#8b5cf6', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899', '#84cc16']
        };

        let currentPeriod = 'all';
        let globalData = null;
        let globalFinData = null;

        function setPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            updateMetricsForPeriod();
        }

        function updateMetricsForPeriod() {
            if (!globalFinData) return;
            
            const now = new Date();
            const thisMonth = now.toISOString().slice(0, 7);
            const weekly = globalFinData.weekly || [];
            const monthly = globalFinData.monthly || [];
            
            let revenue = 0, cogs = 0, opex = 0, days = 0;
            
            if (currentPeriod === 'all') {
                revenue = globalFinData.pnl.revenue.total;
                cogs = globalFinData.pnl.cogs.total;
                opex = globalFinData.pnl.opex.total;
                days = globalFinData.period ? (globalFinData.period.days || monthly.length * 30) : 61;
            } else if (currentPeriod === 'month') {
                // Get current month data
                const monthData = monthly.find(m => m.month === thisMonth) || monthly[monthly.length - 1];
                if (monthData) {
                    revenue = monthData.revenue;
                    cogs = monthData.cogs;
                    opex = monthData.opex;
                    days = 30;
                }
            } else if (currentPeriod === 'week') {
                // Get latest week data
                const weekData = weekly[weekly.length - 1];
                if (weekData) {
                    revenue = weekData.revenue;
                    cogs = weekData.cogs;
                    opex = weekData.opex;
                    days = 7;
                }
            }
            
            document.getElementById('totalRevenue').textContent = formatCurrency(revenue);
            document.getElementById('avgDaily').textContent = formatCurrency(revenue / Math.max(days, 1)) + ' avg/day';
            document.getElementById('totalCogs').textContent = formatCurrency(cogs);
            document.getElementById('totalOpex').textContent = formatCurrency(opex);
            document.getElementById('daysRecorded').textContent = days;
            
            const profit = revenue - cogs - opex;
            document.getElementById('operatingProfit').textContent = formatCurrency(profit);
            document.getElementById('operatingProfit').className = 'value ' + (profit >= 0 ? 'positive' : 'negative');
        }

        function formatCurrency(value) {
            if (Math.abs(value) >= 100000) {
                return (value / 100000).toFixed(2) + 'L';
            }
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat('en-IN').format(Math.round(value));
        }

        // Expandable panel toggle
        function toggleExpand(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('expanded');
        }

        // Render Revenue details (by Channel)
        function renderRevenueDetails(finData) {
            if (!finData || !finData.pnl || !finData.pnl.revenue) return;

            const byChannel = finData.pnl.revenue.by_channel || {};
            const bySource = finData.pnl.revenue.by_source || finData.pnl.revenue.breakdown || {};

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showRevenueView('channel')">By Channel</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showRevenueView('source')">By Source</button>
                </div>
                <div id="revenueChannelView">
                    ${Object.entries(byChannel)
                        .filter(([_, amt]) => amt > 0)
                        .sort((a, b) => b[1] - a[1])
                        .map(([channel, amount]) => `
                            <div class="detail-row">
                                <span class="label">${channel}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
                <div id="revenueSourceView" style="display:none">
                    ${Object.entries(bySource)
                        .sort((a, b) => b[1] - a[1])
                        .map(([source, amount]) => `
                            <div class="detail-row">
                                <span class="label">${source}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('revenueDetails').innerHTML = html;
        }

        function showRevenueView(view) {
            document.getElementById('revenueChannelView').style.display = view === 'channel' ? 'block' : 'none';
            document.getElementById('revenueSourceView').style.display = view === 'source' ? 'block' : 'none';
            document.querySelectorAll('#revenueDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'channel' && i === 0) || (view === 'source' && i === 1));
            });
        }

        // Render COGS details (by Vendor + by Category)
        function renderCogsDetails(finData) {
            if (!finData || !finData.pnl || !finData.pnl.cogs) return;

            const byVendor = finData.pnl.cogs.by_vendor || finData.pnl.cogs.breakdown || {};
            const byCategory = finData.pnl.cogs.by_category || {};

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showCogsView('category')">By Category</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showCogsView('vendor')">By Vendor</button>
                </div>
                <div id="cogsCategoryView">
                    ${Object.entries(byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => `
                            <div class="detail-row">
                                <span class="label">${cat}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
                <div id="cogsVendorView" style="display:none">
                    ${Object.entries(byVendor)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 10)
                        .map(([vendor, amount]) => `
                            <div class="detail-row">
                                <span class="label">${vendor.replace(' (partner-paid)', '').replace(' (invoiced)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                    ${Object.keys(byVendor).length > 10 ? '<div class="detail-row"><span class="label" style="color:#64748b">...and more</span></div>' : ''}
                </div>
            `;
            document.getElementById('cogsDetails').innerHTML = html;
        }

        function showCogsView(view) {
            document.getElementById('cogsCategoryView').style.display = view === 'category' ? 'block' : 'none';
            document.getElementById('cogsVendorView').style.display = view === 'vendor' ? 'block' : 'none';
            document.querySelectorAll('#cogsDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'category' && i === 0) || (view === 'vendor' && i === 1));
            });
        }

        // Render OpEx details (by Category + Fixed/Variable)
        function renderOpexDetails(finData) {
            if (!finData || !finData.pnl || !finData.pnl.opex) return;

            const byCategory = finData.pnl.opex.by_category || finData.pnl.opex.breakdown || {};
            const fixed = finData.pnl.opex.fixed || {};
            const variable = finData.pnl.opex.variable || {};
            const fixedTotal = finData.pnl.opex.fixed_total || 0;
            const variableTotal = finData.pnl.opex.variable_total || 0;

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showOpexView('category')">By Category</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showOpexView('fixedvar')">Fixed/Variable</button>
                </div>
                <div id="opexCategoryView">
                    ${Object.entries(byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 8)
                        .map(([cat, amount]) => `
                            <div class="detail-row">
                                <span class="label">${cat.replace(' (partner-paid)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                    ${Object.keys(byCategory).length > 8 ? '<div class="detail-row"><span class="label" style="color:#64748b">...and more</span></div>' : ''}
                </div>
                <div id="opexFixedVarView" style="display:none">
                    <div class="detail-section-title">Fixed Costs <span class="badge-fixed">${formatCurrency(fixedTotal)}</span></div>
                    ${Object.entries(fixed)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => `
                            <div class="detail-row sub-item">
                                <span class="label">${cat.replace(' (partner-paid)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                    <div class="detail-section-title">Variable Costs <span class="badge-variable">${formatCurrency(variableTotal)}</span></div>
                    ${Object.entries(variable)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => `
                            <div class="detail-row sub-item">
                                <span class="label">${cat.replace(' (partner-paid)', '')}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('opexDetails').innerHTML = html;
        }

        function showOpexView(view) {
            document.getElementById('opexCategoryView').style.display = view === 'category' ? 'block' : 'none';
            document.getElementById('opexFixedVarView').style.display = view === 'fixedvar' ? 'block' : 'none';
            document.querySelectorAll('#opexDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'category' && i === 0) || (view === 'fixedvar' && i === 1));
            });
        }

        // Render CapEx details (by Category + by Partner)
        function renderCapexDetails(finData) {
            if (!finData || !finData.capex) return;

            const byCategory = finData.capex.by_category || finData.capex.breakdown || {};
            const byPartner = finData.capex.by_partner || {};
            const details = finData.capex.details || {};

            let html = `
                <div class="view-toggle">
                    <button class="view-btn active" onclick="event.stopPropagation(); showCapexView('category')">By Category</button>
                    <button class="view-btn" onclick="event.stopPropagation(); showCapexView('partner')">By Partner</button>
                </div>
                <div id="capexCategoryView">
                    ${Object.entries(byCategory)
                        .sort((a, b) => b[1] - a[1])
                        .map(([cat, amount]) => {
                            const partnerBreakdown = details[cat] || {};
                            const partnerStr = Object.entries(partnerBreakdown)
                                .map(([p, a]) => `${p}: ${formatCurrency(a)}`)
                                .join(', ');
                            return `
                                <div class="detail-row">
                                    <span class="label">${cat}</span>
                                    <span class="amount">${formatCurrency(amount)}</span>
                                </div>
                                ${partnerStr ? `<div class="detail-row sub-item"><span class="label">${partnerStr}</span></div>` : ''}
                            `;
                        }).join('')}
                </div>
                <div id="capexPartnerView" style="display:none">
                    ${Object.entries(byPartner)
                        .sort((a, b) => b[1] - a[1])
                        .map(([partner, amount]) => `
                            <div class="detail-row">
                                <span class="label">${partner}</span>
                                <span class="amount">${formatCurrency(amount)}</span>
                            </div>
                        `).join('')}
                </div>
            `;
            document.getElementById('capexDetails').innerHTML = html;
        }

        function showCapexView(view) {
            document.getElementById('capexCategoryView').style.display = view === 'category' ? 'block' : 'none';
            document.getElementById('capexPartnerView').style.display = view === 'partner' ? 'block' : 'none';
            document.querySelectorAll('#capexDetails .view-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (view === 'category' && i === 0) || (view === 'partner' && i === 1));
            });
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        let chartInstances = {};

        async function loadDashboard() {
            try {
                // Cache-busting timestamp to ensure fresh data
                const cacheBuster = '?v=' + Date.now();

                // Load operational data
                let response;
                const paths = ['../data/dashboard_data.json', './data/dashboard_data.json', 'data/dashboard_data.json'];
                for (const path of paths) {
                    try {
                        response = await fetch(path + cacheBuster, { cache: 'no-store' });
                        if (response.ok) break;
                    } catch { continue; }
                }
                if (!response || !response.ok) throw new Error('Data not found');
                const data = await response.json();

                // Load financial data
                let finResponse;
                const finPaths = ['../data/financial_data.json', './data/financial_data.json', 'data/financial_data.json'];
                for (const path of finPaths) {
                    try {
                        finResponse = await fetch(path + cacheBuster, { cache: 'no-store' });
                        if (finResponse.ok) break;
                    } catch { continue; }
                }
                let finData = null;
                if (finResponse && finResponse.ok) {
                    finData = await finResponse.json();
                }

                renderDashboard(data, finData);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('topItemsTable').innerHTML =
                    '<tr><td colspan="5" style="color:#ef4444">Error loading data</td></tr>';
            }
        }

        function renderDashboard(data, finData) {
            const updated = new Date(data.last_updated);
            document.getElementById('lastUpdated').textContent =
                `Updated: ${updated.toLocaleDateString('en-IN')} ${updated.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'})}`;

            // Store globally for detail rendering
            globalFinData = finData;

            // Render expandable detail panels
            if (finData) {
                renderRevenueDetails(finData);
                renderCogsDetails(finData);
                renderOpexDetails(finData);
                renderCapexDetails(finData);
            }

            // Use financial data if available for more accurate metrics
            if (finData && finData.pnl) {
                // Overview metrics from bank statement data
                document.getElementById('totalRevenue').textContent = formatCurrency(finData.pnl.revenue.total);
                document.getElementById('avgDaily').textContent = `${finData.pnl.gross_margin_pct}% gross margin`;
                document.getElementById('totalCogs').textContent = formatCurrency(finData.pnl.cogs.total);
                document.getElementById('cogsSubtext').textContent = `${finData.pnl.cogs_pct}% of revenue`;
                document.getElementById('totalOpex').textContent = formatCurrency(finData.pnl.opex.total);
                const fixedPct = finData.pnl.opex.fixed_total ? Math.round(finData.pnl.opex.fixed_total / finData.pnl.opex.total * 100) : 0;
                document.getElementById('opexSubtext').textContent = `${fixedPct}% fixed, ${100-fixedPct}% variable`;
                document.getElementById('totalCapex').textContent = formatCurrency(finData.capex ? finData.capex.total : finData.pnl.capex);
                document.getElementById('itemsSold').textContent = formatNumber(data.metrics.total_items_sold);
                document.getElementById('avgItems').textContent = `${Math.round(data.metrics.avg_daily_items)} avg/day`;
                document.getElementById('daysRecorded').textContent = finData ? finData.reconciliation.revenue.petpooja_sales > 0 ? 
                    finData.period.days || data.metrics.days_recorded : data.metrics.days_recorded : data.metrics.days_recorded;

                const profit = finData.pnl.net_profit;
                document.getElementById('profitLabel').textContent = 'Net Profit';
                document.getElementById('operatingProfit').textContent = formatCurrency(profit);
                document.getElementById('operatingProfit').className = 'value ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('profitCard').className = 'metric-card ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('marginPct').textContent = `${finData.pnl.operating_margin_pct}% op. margin`;
            } else {
                // Fallback to operational data
                document.getElementById('totalRevenue').textContent = formatCurrency(data.metrics.total_revenue);
                document.getElementById('avgDaily').textContent = `${formatCurrency(data.metrics.avg_daily_revenue)} avg/day`;
                document.getElementById('totalCogs').textContent = '--';
                document.getElementById('cogsSubtext').textContent = 'No data';
                document.getElementById('totalOpex').textContent = formatCurrency(data.metrics.total_opex);
                document.getElementById('totalCapex').textContent = formatCurrency(data.metrics.total_capex);
                document.getElementById('itemsSold').textContent = formatNumber(data.metrics.total_items_sold);
                document.getElementById('avgItems').textContent = `${Math.round(data.metrics.avg_daily_items)} avg/day`;
                document.getElementById('daysRecorded').textContent = finData ? finData.reconciliation.revenue.petpooja_sales > 0 ? 
                    finData.period.days || data.metrics.days_recorded : data.metrics.days_recorded : data.metrics.days_recorded;

                const profit = data.metrics.operating_profit;
                document.getElementById('profitLabel').textContent = 'Operating Profit';
                document.getElementById('operatingProfit').textContent = formatCurrency(profit);
                document.getElementById('operatingProfit').className = 'value ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('profitCard').className = 'metric-card ' + (profit >= 0 ? 'positive' : 'negative');
                document.getElementById('marginPct').textContent =
                    `${data.metrics.gross_margin_pct > 0 ? '+' : ''}${data.metrics.gross_margin_pct}% margin`;
            }

            // Charts
            renderRevenueTrendChart(data.daily_sales);
            renderCategoryChart(data.category_sales);
            if (finData && finData.pnl) {
                renderOpexChart(finData.pnl.opex.breakdown);
            } else {
                renderOpexChart(data.expenses.opex.breakdown);
            }
            renderSalesItemsChart(data.daily_sales);

            // Use financial monthly data if available
            if (finData && finData.monthly) {
                renderMonthlyPnlChart(finData.monthly);
                renderMonthlyPnlTable(finData.monthly);
            } else {
                renderMonthlyPnlChart(data.monthly_pnl);
                renderMonthlyPnlTable(data.monthly_pnl);
            }

            // Tables
            try { renderTopItemsTable(data.top_items); } catch(e) { console.error('TopItems error:', e); }
            try { renderCategoryTable(data.category_sales); } catch(e) { console.error('Category error:', e); }
            try { renderAllItemsTable(data.top_items); } catch(e) { console.error('AllItems error:', e); }
            // Use financial data for expenses (has correct breakdown)
            if (finData && finData.expenses) {
                try { renderExpensesTables(finData.expenses); } catch(e) { console.error('Expenses error:', e); }
            }
            try { renderBalanceSheet(finData); } catch(e) { console.error('BalanceSheet error:', e); }
            try { renderPnlStatement(data, finData); } catch(e) { console.error('PnL error:', e); }
        }

        function renderRevenueTrendChart(dailySales) {
            const sorted = [...dailySales].sort((a, b) => new Date(a.date) - new Date(b.date));
            const ctx = document.getElementById('revenueTrendChart').getContext('2d');

            if (chartInstances.revenueTrend) chartInstances.revenueTrend.destroy();
            chartInstances.revenueTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Revenue',
                        data: sorted.map(d => d.revenue || d.total_sales),
                        borderColor: colors.primary,
                        backgroundColor: colors.primary + '20',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: v => formatCurrency(v) }
                        }
                    }
                }
            });
        }

        function renderCategoryChart(categorySales) {
            const categories = Object.entries(categorySales).sort((a, b) => b[1].revenue - a[1].revenue);
            const ctx = document.getElementById('categoryChart').getContext('2d');

            if (chartInstances.category) chartInstances.category.destroy();
            chartInstances.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories.map(([name]) => name),
                    datasets: [{
                        data: categories.map(([, d]) => d.revenue),
                        backgroundColor: colors.chart,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } }
                    }
                }
            });
        }

        function renderOpexChart(opexByCategory) {
            const categories = Object.entries(opexByCategory).sort((a, b) => b[1] - a[1]).slice(0, 7);
            const ctx = document.getElementById('opexChart').getContext('2d');

            if (chartInstances.opex) chartInstances.opex.destroy();
            chartInstances.opex = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(([name]) => name),
                    datasets: [{
                        data: categories.map(([, v]) => v),
                        backgroundColor: colors.chart,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { callback: v => formatCurrency(v) } }
                    }
                }
            });
        }

        function renderSalesItemsChart(dailySales) {
            const sorted = [...dailySales].sort((a, b) => new Date(a.date) - new Date(b.date));
            const ctx = document.getElementById('salesItemsChart').getContext('2d');

            if (chartInstances.salesItems) chartInstances.salesItems.destroy();
            chartInstances.salesItems = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => {
                        const date = new Date(d.date);
                        return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
                    }),
                    datasets: [{
                        label: 'Revenue',
                        data: sorted.map(d => d.revenue || d.total_sales),
                        backgroundColor: colors.primary,
                        yAxisID: 'y'
                    }, {
                        label: 'Items Sold',
                        data: sorted.map(d => d.items_sold || 0),
                        type: 'line',
                        borderColor: colors.success,
                        backgroundColor: 'transparent',
                        yAxisID: 'y1',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', ticks: { callback: v => formatCurrency(v) } },
                        y1: { position: 'right', grid: { drawOnChartArea: false } }
                    }
                }
            });
        }

        function renderMonthlyPnlChart(monthlyPnl) {
            const ctx = document.getElementById('monthlyPnlChart').getContext('2d');
            const hasCogs = monthlyPnl.some(m => m.cogs !== undefined);

            if (chartInstances.monthlyPnl) chartInstances.monthlyPnl.destroy();
            chartInstances.monthlyPnl = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyPnl.map(m => m.month),
                    datasets: hasCogs ? [
                        {
                            label: 'Revenue',
                            data: monthlyPnl.map(m => m.revenue),
                            backgroundColor: colors.primary
                        }, {
                            label: 'COGS',
                            data: monthlyPnl.map(m => m.cogs || 0),
                            backgroundColor: colors.secondary
                        }, {
                            label: 'OpEx',
                            data: monthlyPnl.map(m => m.opex),
                            backgroundColor: colors.warning
                        }, {
                            label: 'Operating Profit',
                            data: monthlyPnl.map(m => m.operating_profit),
                            backgroundColor: monthlyPnl.map(m => m.operating_profit >= 0 ? colors.success : colors.danger)
                        }
                    ] : [
                        {
                            label: 'Revenue',
                            data: monthlyPnl.map(m => m.revenue),
                            backgroundColor: colors.primary
                        }, {
                            label: 'OpEx',
                            data: monthlyPnl.map(m => m.opex),
                            backgroundColor: colors.warning
                        }, {
                            label: 'Operating Profit',
                            data: monthlyPnl.map(m => m.operating_profit),
                            backgroundColor: monthlyPnl.map(m => m.operating_profit >= 0 ? colors.success : colors.danger)
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { ticks: { callback: v => formatCurrency(v) } }
                    }
                }
            });
        }

        function renderTopItemsTable(topItems) {
            document.getElementById('topItemsTable').innerHTML = topItems.slice(0, 15).map((item, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${item.item}</td>
                    <td><span class="category-badge">${item.category}</span></td>
                    <td class="right">${formatNumber(item.qty)}</td>
                    <td class="right">${formatCurrency(item.revenue)}</td>
                </tr>
            `).join('');
        }

        function renderCategoryTable(categorySales) {
            const sorted = Object.entries(categorySales).sort((a, b) => b[1].revenue - a[1].revenue);
            const total = sorted.reduce((sum, [, d]) => sum + d.revenue, 0);

            document.getElementById('categoryTable').innerHTML = sorted.map(([name, data]) => `
                <tr>
                    <td>${name}</td>
                    <td class="right">${formatNumber(data.qty)}</td>
                    <td class="right">${formatCurrency(data.revenue)}</td>
                </tr>
            `).join('') + `
                <tr class="total-row">
                    <td>Total</td>
                    <td class="right">${formatNumber(sorted.reduce((s, [,d]) => s + d.qty, 0))}</td>
                    <td class="right">${formatCurrency(total)}</td>
                </tr>
            `;
        }

        function renderAllItemsTable(items) {
            document.getElementById('allItemsTable').innerHTML = items.map(item => `
                <tr>
                    <td>${item.item}</td>
                    <td class="right">${formatNumber(item.qty)}</td>
                    <td class="right">${formatCurrency(item.revenue)}</td>
                </tr>
            `).join('');
        }

        function renderMonthlyPnlTable(monthlyPnl) {
            // Handle both old format (without cogs) and new format (with cogs)
            document.getElementById('monthlyPnlTable').innerHTML = monthlyPnl.map(m => {
                const cogs = m.cogs !== undefined ? m.cogs : 0;
                const grossProfit = m.gross_profit !== undefined ? m.gross_profit : m.revenue;
                return `
                    <tr>
                        <td>${m.month}</td>
                        <td class="right">${formatCurrency(m.revenue)}</td>
                        <td class="right">${formatCurrency(cogs)}</td>
                        <td class="right" style="color:${grossProfit >= 0 ? '#22c55e' : '#ef4444'}">${formatCurrency(grossProfit)}</td>
                        <td class="right">${formatCurrency(m.opex)}</td>
                        <td class="right" style="color:${m.operating_profit >= 0 ? '#22c55e' : '#ef4444'}">${formatCurrency(m.operating_profit)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderExpensesTables(expenses) {
            document.getElementById('expTotal').textContent = formatCurrency(expenses.total);
            document.getElementById('expOpex').textContent = formatCurrency(expenses.opex.total);
            document.getElementById('expCapex').textContent = formatCurrency(expenses.capex.total);

            const capexSorted = Object.entries(expenses.capex.by_category).sort((a, b) => b[1] - a[1]);
            document.getElementById('capexTable').innerHTML = capexSorted.map(([name, amount]) => `
                <tr><td>${name}</td><td class="right">${formatCurrency(amount)}</td></tr>
            `).join('') + `
                <tr class="total-row"><td>Total CapEx</td><td class="right">${formatCurrency(expenses.capex.total)}</td></tr>
            `;

            const opexSorted = Object.entries(expenses.opex.breakdown).sort((a, b) => b[1] - a[1]);
            document.getElementById('opexTable').innerHTML = opexSorted.map(([name, amount]) => `
                <tr><td>${name}</td><td class="right">${formatCurrency(amount)}</td></tr>
            `).join('') + `
                <tr class="total-row"><td>Total OpEx</td><td class="right">${formatCurrency(expenses.opex.total)}</td></tr>
            `;

            // Partner contributions (from capex by_partner if available)
            const partnerData = expenses.by_partner || {};
            const partnerSorted = Object.entries(partnerData).sort((a, b) => b[1] - a[1]);
            if (partnerSorted.length > 0) {
                document.getElementById('partnerTable').innerHTML = partnerSorted.map(([name, amount]) => `
                    <tr><td>${name}</td><td class="right">${formatCurrency(amount)}</td></tr>
                `).join('') + `
                    <tr class="total-row"><td>Total</td><td class="right">${formatCurrency(Object.values(partnerData).reduce((a,b) => a+b, 0))}</td></tr>
                `;
            } else {
                document.getElementById('partnerTable').innerHTML = '<tr><td colspan="2" style="color:#64748b">Partner breakdown not available</td></tr>';
            }
        }

        function renderBalanceSheet(finData) {
            if (!finData || !finData.balance_sheet) return;
            
            const bs = finData.balance_sheet;
            
            // Summary metrics
            document.getElementById('bsAssets').textContent = formatCurrency(bs.assets.total);
            document.getElementById('bsLiabilities').textContent = formatCurrency(bs.liabilities.total);
            document.getElementById('bsEquity').textContent = formatCurrency(bs.equity.total);
            document.getElementById('bsAsOf').textContent = bs.as_of;
            
            // Assets table
            let assetsHtml = '';
            assetsHtml += '<tr class="section-header"><td colspan="2"><strong>Current Assets</strong></td></tr>';
            assetsHtml += '<tr><td class="indent">Cash & Bank</td><td class="right">' + formatCurrency(bs.assets.current.cash) + '</td></tr>';
            if (bs.assets.current.receivables > 0) {
                assetsHtml += '<tr><td class="indent">Receivables</td><td class="right">' + formatCurrency(bs.assets.current.receivables) + '</td></tr>';
            }
            
            if (bs.assets.non_current && bs.assets.non_current.security_deposits > 0) {
                assetsHtml += '<tr class="section-header"><td colspan="2"><strong>Non-Current Assets</strong></td></tr>';
                assetsHtml += '<tr><td class="indent">Security Deposits</td><td class="right">' + formatCurrency(bs.assets.non_current.security_deposits) + '</td></tr>';
            }
            
            assetsHtml += '<tr class="section-header"><td colspan="2"><strong>Fixed Assets</strong></td></tr>';
            assetsHtml += '<tr><td class="indent">Equipment</td><td class="right">' + formatCurrency(bs.assets.fixed.equipment) + '</td></tr>';
            assetsHtml += '<tr><td class="indent">Furniture</td><td class="right">' + formatCurrency(bs.assets.fixed.furniture) + '</td></tr>';
            assetsHtml += '<tr><td class="indent">Interior</td><td class="right">' + formatCurrency(bs.assets.fixed.interior) + '</td></tr>';
            assetsHtml += '<tr class="total-row"><td><strong>Total Assets</strong></td><td class="right"><strong>' + formatCurrency(bs.assets.total) + '</strong></td></tr>';
            
            document.getElementById('assetsTable').innerHTML = assetsHtml;
            
            // Liabilities & Equity table
            let liabHtml = '';
            liabHtml += '<tr class="section-header"><td colspan="2"><strong>Current Liabilities</strong></td></tr>';
            liabHtml += '<tr><td class="indent">Accounts Payable</td><td class="right">' + formatCurrency(bs.liabilities.current.accounts_payable) + '</td></tr>';
            liabHtml += '<tr class="subtotal-row"><td>Total Liabilities</td><td class="right">' + formatCurrency(bs.liabilities.total) + '</td></tr>';
            
            liabHtml += '<tr class="section-header"><td colspan="2"><strong>Equity</strong></td></tr>';
            liabHtml += '<tr><td class="indent">Partner Capital</td><td class="right">' + formatCurrency(bs.equity.partner_capital) + '</td></tr>';
            liabHtml += '<tr class="total-row"><td><strong>Total Liabilities + Equity</strong></td><td class="right"><strong>' + formatCurrency(bs.liabilities.total + bs.equity.total) + '</strong></td></tr>';
            
            document.getElementById('liabilitiesTable').innerHTML = liabHtml;
        }

        function renderPnlStatement(data, finData) {
            if (finData && finData.pnl) {
                // Use financial data from bank statement
                const pnl = finData.pnl;

                // Period
                document.getElementById('pnlPeriod').textContent =
                    `Period: ${pnl.period.start} to ${pnl.period.end}`;

                // Revenue breakdown
                const revenueLines = Object.entries(pnl.revenue.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlRevenueLines').innerHTML = revenueLines;
                document.getElementById('pnlTotalRevenue').textContent = formatCurrency(pnl.revenue.total);

                // COGS breakdown
                const cogsLines = Object.entries(pnl.cogs.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlCogsLines').innerHTML = cogsLines;
                document.getElementById('pnlTotalCogs').textContent = formatCurrency(pnl.cogs.total);

                // Gross profit
                document.getElementById('pnlGrossProfit').textContent = formatCurrency(pnl.gross_profit);
                document.getElementById('pnlGrossProfit').style.color = pnl.gross_profit >= 0 ? '#22c55e' : '#ef4444';
                document.getElementById('pnlGrossMargin').textContent = `${pnl.gross_margin_pct}%`;

                // OpEx breakdown
                const opexLines = Object.entries(pnl.opex.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlOpexLines').innerHTML = opexLines;
                document.getElementById('pnlTotalOpex').textContent = formatCurrency(pnl.opex.total);

                // Operating profit
                document.getElementById('pnlOperatingProfit').textContent = formatCurrency(pnl.operating_profit);
                document.getElementById('pnlOperatingProfit').style.color = pnl.operating_profit >= 0 ? '#22c55e' : '#ef4444';
                document.getElementById('pnlOpMargin').textContent = `${pnl.operating_margin_pct}%`;

                // Other expenses
                document.getElementById('pnlOtherExpenses').textContent = formatCurrency(pnl.other_expenses);

                // Net profit
                document.getElementById('pnlNetProfit').textContent = formatCurrency(pnl.net_profit);
                document.getElementById('pnlNetProfit').style.color = pnl.net_profit >= 0 ? '#22c55e' : '#ef4444';

                // Render vendor table
                if (finData.vendors) {
                    const vendorRows = finData.vendors.slice(0, 15).map(v => `
                        <tr>
                            <td>${v.vendor}</td>
                            <td><span class="category-badge">${v.category}</span></td>
                            <td class="right">${formatCurrency(v.total)}</td>
                        </tr>
                    `).join('');
                    document.getElementById('vendorTable').innerHTML = vendorRows;
                }
            } else {
                // Fallback to operational data
                document.getElementById('pnlPeriod').textContent = '';
                document.getElementById('pnlRevenueLines').innerHTML = `
                    <div class="pnl-row indent">
                        <span>Sales Revenue</span>
                        <span>${formatCurrency(data.pnl_summary.revenue)}</span>
                    </div>
                `;
                document.getElementById('pnlTotalRevenue').textContent = formatCurrency(data.pnl_summary.revenue);
                document.getElementById('pnlCogsLines').innerHTML = '<div class="pnl-row indent"><span>No COGS data</span><span>--</span></div>';
                document.getElementById('pnlTotalCogs').textContent = '--';
                document.getElementById('pnlGrossProfit').textContent = '--';
                document.getElementById('pnlGrossMargin').textContent = '--';

                const opexLines = Object.entries(data.expenses.opex.breakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, amount]) => `
                        <div class="pnl-row indent">
                            <span>${name}</span>
                            <span>${formatCurrency(amount)}</span>
                        </div>
                    `).join('');
                document.getElementById('pnlOpexLines').innerHTML = opexLines;
                document.getElementById('pnlTotalOpex').textContent = formatCurrency(data.pnl_summary.operating_expenses);

                const profit = data.pnl_summary.operating_profit;
                document.getElementById('pnlOperatingProfit').textContent = formatCurrency(profit);
                document.getElementById('pnlOperatingProfit').style.color = profit >= 0 ? '#22c55e' : '#ef4444';
                document.getElementById('pnlOpMargin').textContent = '--';
                document.getElementById('pnlOtherExpenses').textContent = '--';
                document.getElementById('pnlNetProfit').textContent = formatCurrency(profit);
                document.getElementById('pnlNetProfit').style.color = profit >= 0 ? '#22c55e' : '#ef4444';
            }
        }

        // ============================================
        // REFRESH DATA FUNCTIONALITY
        // ============================================
        const API_URL = 'http://localhost:5050';
        let refreshCheckInterval = null;

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            const statusEl = document.getElementById('refreshStatus');

            // Update button state
            btn.disabled = true;
            btn.classList.add('loading');
            btn.querySelector('.refresh-text').textContent = 'Fetching...';
            statusEl.textContent = 'Connecting to server...';
            statusEl.className = 'refresh-status';

            try {
                // Trigger update
                const response = await fetch(`${API_URL}/update`, { method: 'POST' });
                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.textContent = 'Update started, fetching emails...';
                    // Start polling for completion
                    startStatusPolling();
                } else {
                    throw new Error(data.message || 'Failed to start update');
                }
            } catch (error) {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.querySelector('.refresh-text').textContent = 'Refresh Data';
                statusEl.textContent = 'Error: ' + (error.message.includes('Failed to fetch')
                    ? 'API server not running. Start with: python api_server.py'
                    : error.message);
                statusEl.className = 'refresh-status error';
            }
        }

        function startStatusPolling() {
            // Poll every 2 seconds for status
            refreshCheckInterval = setInterval(checkRefreshStatus, 2000);
        }

        async function checkRefreshStatus() {
            const btn = document.getElementById('refreshBtn');
            const statusEl = document.getElementById('refreshStatus');

            try {
                const response = await fetch(`${API_URL}/status`);
                const status = await response.json();

                if (!status.running) {
                    // Update complete
                    clearInterval(refreshCheckInterval);
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    btn.querySelector('.refresh-text').textContent = 'Refresh Data';

                    if (status.last_result && status.last_result.success) {
                        statusEl.textContent = 'Update complete! Reloading...';
                        statusEl.className = 'refresh-status success';
                        // Reload dashboard data
                        setTimeout(() => {
                            loadDashboard();
                            statusEl.textContent = 'Data refreshed successfully';
                        }, 1000);
                    } else {
                        statusEl.textContent = 'Update failed: ' + (status.last_error || 'Unknown error');
                        statusEl.className = 'refresh-status error';
                    }
                } else {
                    statusEl.textContent = 'Processing... please wait';
                }
            } catch (error) {
                // Server might be busy, continue polling
            }
        }

        // Check if API server is available on load
        async function checkApiServer() {
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    document.getElementById('refreshBtn').style.display = 'flex';
                }
            } catch {
                // API server not running - button still visible but will show error
            }
        }

        loadDashboard();
        checkApiServer();
    </script>
</body>
</html>
